<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>construct_models_gurobi.params_gurobi &mdash; Vatic-Gurobipy 1.0.0 documentation</title>
      <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script src="../../_static/jquery.js"></script>
        <script src="../../_static/_sphinx_javascript_frameworks_compat.js"></script>
        <script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js"></script>
        <script src="../../_static/doctools.js"></script>
        <script src="../../_static/sphinx_highlight.js"></script>
    <script src="../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../index.html" class="icon icon-home">
            Vatic-Gurobipy
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">User Guide</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../main_model_functions_gurobi.html">main_model_functions_gurobi</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../construct_models_gurobi.html">construct_models_gurobi</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../transmission_gurobi.html">transmission_gurobi</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">Vatic-Gurobipy</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../index.html">Module code</a></li>
      <li class="breadcrumb-item active">construct_models_gurobi.params_gurobi</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for construct_models_gurobi.params_gurobi</h1><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Load and validate input of grid data to gurobi models</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">from</span> <span class="nn">vatic.models_gurobi.src.construct_models_gurobi._utils_gurobi</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">ModelError</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span> <span class="nn">vatic.model_data</span> <span class="kn">import</span> <span class="n">VaticModelData</span>

<span class="kn">from</span> <span class="nn">egret.model_library.transmission</span> <span class="kn">import</span> <span class="n">tx_utils</span>
<span class="kn">from</span> <span class="nn">egret.common.log</span> <span class="kn">import</span> <span class="n">logger</span>
<span class="kn">from</span> <span class="nn">egret.model_library.unit_commitment.uc_utils</span> <span class="kn">import</span> <span class="n">uc_time_helper</span>

<span class="kn">import</span> <span class="nn">math</span>
<span class="kn">from</span> <span class="nn">ordered_set</span> <span class="kn">import</span> <span class="n">OrderedSet</span>
<span class="kn">import</span> <span class="nn">gurobipy</span> <span class="k">as</span> <span class="nn">gp</span>
<span class="kn">from</span> <span class="nn">gurobipy</span> <span class="kn">import</span> <span class="n">tupledict</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Optional</span>


<div class="viewcode-block" id="default_params"><a class="viewcode-back" href="../../construct_models_gurobi.html#construct_models_gurobi.params_gurobi.default_params">[docs]</a><span class="k">def</span> <span class="nf">default_params</span><span class="p">(</span>
        <span class="n">model</span><span class="p">:</span> <span class="n">gp</span><span class="o">.</span><span class="n">Model</span><span class="p">,</span> <span class="n">model_data</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">VaticModelData</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">gp</span><span class="o">.</span><span class="n">Model</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Call main function to load grid data into parameters of gurobi model</span>
<span class="sd">    without renewable costs</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">load_base_params</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">model_data</span><span class="p">,</span> <span class="n">renew_costs</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span></div>


<div class="viewcode-block" id="renew_cost_params"><a class="viewcode-back" href="../../construct_models_gurobi.html#construct_models_gurobi.params_gurobi.renew_cost_params">[docs]</a><span class="k">def</span> <span class="nf">renew_cost_params</span><span class="p">(</span>
        <span class="n">model</span><span class="p">:</span> <span class="n">gp</span><span class="o">.</span><span class="n">Model</span><span class="p">,</span> <span class="n">model_data</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">VaticModelData</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">gp</span><span class="o">.</span><span class="n">Model</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Call main function to load grid data into parameters of gurobi model</span>
<span class="sd">    with renewable costs</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">load_base_params</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">model_data</span><span class="p">,</span> <span class="n">renew_costs</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span></div>


<div class="viewcode-block" id="load_base_params"><a class="viewcode-back" href="../../construct_models_gurobi.html#construct_models_gurobi.params_gurobi.load_base_params">[docs]</a><span class="k">def</span> <span class="nf">load_base_params</span><span class="p">(</span>
        <span class="n">model</span><span class="p">:</span> <span class="n">gp</span><span class="o">.</span><span class="n">Model</span><span class="p">,</span>
        <span class="n">model_data</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">VaticModelData</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">renew_costs</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">gp</span><span class="o">.</span><span class="n">Model</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Main Function to Load grid data into parameters of gurobi model </span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">time_keys</span> <span class="o">=</span> <span class="n">model_data</span><span class="o">.</span><span class="n">get_system_attr</span><span class="p">(</span><span class="s2">&quot;time_keys&quot;</span><span class="p">)</span>

    <span class="c1"># NOTE: generator, bus, and load should be in here for</span>
    <span class="c1"># a well-defined problem</span>
    <span class="n">loads</span> <span class="o">=</span> <span class="n">tupledict</span><span class="p">(</span><span class="n">model_data</span><span class="o">.</span><span class="n">elements</span><span class="p">(</span><span class="n">element_type</span><span class="o">=</span><span class="s2">&quot;load&quot;</span><span class="p">))</span>
    <span class="n">gens</span> <span class="o">=</span> <span class="n">tupledict</span><span class="p">(</span><span class="n">model_data</span><span class="o">.</span><span class="n">elements</span><span class="p">(</span><span class="n">element_type</span><span class="o">=</span><span class="s2">&quot;generator&quot;</span><span class="p">))</span>

    <span class="n">thermal_gens</span> <span class="o">=</span> <span class="n">tupledict</span><span class="p">(</span>
        <span class="n">model_data</span><span class="o">.</span><span class="n">elements</span><span class="p">(</span><span class="n">element_type</span><span class="o">=</span><span class="s2">&quot;generator&quot;</span><span class="p">,</span> <span class="n">generator_type</span><span class="o">=</span><span class="s2">&quot;thermal&quot;</span><span class="p">)</span>
    <span class="p">)</span>
    <span class="n">renewable_gens</span> <span class="o">=</span> <span class="n">tupledict</span><span class="p">(</span>
        <span class="n">model_data</span><span class="o">.</span><span class="n">elements</span><span class="p">(</span>
            <span class="n">element_type</span><span class="o">=</span><span class="s2">&quot;generator&quot;</span><span class="p">,</span> <span class="n">generator_type</span><span class="o">=</span><span class="s2">&quot;renewable&quot;</span>
        <span class="p">)</span>
    <span class="p">)</span>

    <span class="n">buses</span> <span class="o">=</span> <span class="n">tupledict</span><span class="p">(</span><span class="n">model_data</span><span class="o">.</span><span class="n">elements</span><span class="p">(</span><span class="n">element_type</span><span class="o">=</span><span class="s2">&quot;bus&quot;</span><span class="p">))</span>
    <span class="n">shunts</span> <span class="o">=</span> <span class="n">tupledict</span><span class="p">()</span>
    <span class="n">branches</span> <span class="o">=</span> <span class="n">tupledict</span><span class="p">(</span><span class="n">model_data</span><span class="o">.</span><span class="n">elements</span><span class="p">(</span><span class="n">element_type</span><span class="o">=</span><span class="s2">&quot;branch&quot;</span><span class="p">))</span>
    <span class="n">interfaces</span> <span class="o">=</span> <span class="n">tupledict</span><span class="p">(</span><span class="n">model_data</span><span class="o">.</span><span class="n">elements</span><span class="p">(</span><span class="n">element_type</span><span class="o">=</span><span class="s2">&quot;interface&quot;</span><span class="p">))</span>
    <span class="n">contingencies</span> <span class="o">=</span> <span class="n">tupledict</span><span class="p">()</span>
    <span class="n">storage</span> <span class="o">=</span> <span class="n">tupledict</span><span class="p">(</span><span class="n">model_data</span><span class="o">.</span><span class="n">elements</span><span class="p">(</span><span class="n">element_type</span><span class="o">=</span><span class="s2">&quot;storage&quot;</span><span class="p">))</span>
    <span class="n">dc_branches</span> <span class="o">=</span> <span class="n">tupledict</span><span class="p">()</span>

    <span class="n">thermal_gen_attrs</span> <span class="o">=</span> <span class="n">model_data</span><span class="o">.</span><span class="n">attributes</span><span class="p">(</span>
        <span class="n">element_type</span><span class="o">=</span><span class="s2">&quot;generator&quot;</span><span class="p">,</span> <span class="n">generator_type</span><span class="o">=</span><span class="s2">&quot;thermal&quot;</span>
    <span class="p">)</span>
    <span class="n">renewable_gen_attrs</span> <span class="o">=</span> <span class="n">model_data</span><span class="o">.</span><span class="n">attributes</span><span class="p">(</span>
        <span class="n">element_type</span><span class="o">=</span><span class="s2">&quot;generator&quot;</span><span class="p">,</span> <span class="n">generator_type</span><span class="o">=</span><span class="s2">&quot;renewable&quot;</span>
    <span class="p">)</span>

    <span class="n">bus_attrs</span> <span class="o">=</span> <span class="n">model_data</span><span class="o">.</span><span class="n">attributes</span><span class="p">(</span><span class="n">element_type</span><span class="o">=</span><span class="s2">&quot;bus&quot;</span><span class="p">)</span>
    <span class="n">branch_attrs</span> <span class="o">=</span> <span class="n">model_data</span><span class="o">.</span><span class="n">attributes</span><span class="p">(</span><span class="n">element_type</span><span class="o">=</span><span class="s2">&quot;branch&quot;</span><span class="p">)</span>
    <span class="n">interface_attrs</span> <span class="o">=</span> <span class="n">model_data</span><span class="o">.</span><span class="n">attributes</span><span class="p">(</span><span class="n">element_type</span><span class="o">=</span><span class="s2">&quot;interface&quot;</span><span class="p">)</span>

    <span class="n">storage_attrs</span> <span class="o">=</span> <span class="n">model_data</span><span class="o">.</span><span class="n">attributes</span><span class="p">(</span><span class="n">element_type</span><span class="o">=</span><span class="s2">&quot;storage&quot;</span><span class="p">)</span>
    <span class="n">storage_by_bus</span> <span class="o">=</span> <span class="n">tx_utils</span><span class="o">.</span><span class="n">gens_by_bus</span><span class="p">(</span><span class="n">buses</span><span class="p">,</span> <span class="n">storage</span><span class="p">)</span>

    <span class="n">dc_branch_attrs</span> <span class="o">=</span> <span class="n">tupledict</span><span class="p">(</span><span class="n">names</span><span class="o">=</span><span class="nb">list</span><span class="p">())</span>

    <span class="p">(</span>
        <span class="n">inlet_branches_by_bus</span><span class="p">,</span>
        <span class="n">outlet_branches_by_bus</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">=</span> <span class="n">tx_utils</span><span class="o">.</span><span class="n">inlet_outlet_branches_by_bus</span><span class="p">(</span><span class="n">branches</span><span class="p">,</span> <span class="n">buses</span><span class="p">)</span>
    <span class="p">(</span>
        <span class="n">dc_inlet_branches_by_bus</span><span class="p">,</span>
        <span class="n">dc_outlet_branches_by_bus</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">=</span> <span class="n">tx_utils</span><span class="o">.</span><span class="n">inlet_outlet_branches_by_bus</span><span class="p">(</span><span class="n">dc_branches</span><span class="p">,</span> <span class="n">buses</span><span class="p">)</span>

    <span class="n">thermal_gens_by_bus</span> <span class="o">=</span> <span class="n">tx_utils</span><span class="o">.</span><span class="n">gens_by_bus</span><span class="p">(</span><span class="n">buses</span><span class="p">,</span> <span class="n">thermal_gens</span><span class="p">)</span>
    <span class="n">renewable_gens_by_bus</span> <span class="o">=</span> <span class="n">tx_utils</span><span class="o">.</span><span class="n">gens_by_bus</span><span class="p">(</span><span class="n">buses</span><span class="p">,</span> <span class="n">renewable_gens</span><span class="p">)</span>

    <span class="c1"># get the fixed shunts at the buses</span>
    <span class="p">(</span>
        <span class="n">bus_bs_fixed_shunts</span><span class="p">,</span>
        <span class="n">bus_gs_fixed_shunts</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">=</span> <span class="n">tx_utils</span><span class="o">.</span><span class="n">dict_of_bus_fixed_shunts</span><span class="p">(</span><span class="n">buses</span><span class="p">,</span> <span class="n">shunts</span><span class="p">)</span>

    <span class="c1"># attach some of these to the model object for ease/speed later</span>
    <span class="n">model</span><span class="o">.</span><span class="n">_buses</span> <span class="o">=</span> <span class="n">buses</span>
    <span class="n">model</span><span class="o">.</span><span class="n">_branches</span> <span class="o">=</span> <span class="n">branches</span>
    <span class="n">model</span><span class="o">.</span><span class="n">_shunts</span> <span class="o">=</span> <span class="n">shunts</span>
    <span class="n">model</span><span class="o">.</span><span class="n">_bus_gs_fixed_shunts</span> <span class="o">=</span> <span class="n">bus_gs_fixed_shunts</span>
    <span class="n">model</span><span class="o">.</span><span class="n">_interfaces</span> <span class="o">=</span> <span class="n">interfaces</span>
    <span class="n">model</span><span class="o">.</span><span class="n">_contingencies</span> <span class="o">=</span> <span class="n">contingencies</span>
    <span class="n">model</span><span class="o">.</span><span class="n">_dc_branches</span> <span class="o">=</span> <span class="n">dc_branches</span>

    <span class="c1"># Parameters</span>

    <span class="c1"># String identifiers for the OrderedSet of bus</span>

    <span class="n">model</span><span class="o">.</span><span class="n">_Buses</span> <span class="o">=</span> <span class="n">OrderedSet</span><span class="p">(</span><span class="n">bus_attrs</span><span class="p">[</span><span class="s2">&quot;names&quot;</span><span class="p">])</span>
    <span class="n">ref_bus</span> <span class="o">=</span> <span class="n">model_data</span><span class="o">.</span><span class="n">get_system_attr</span><span class="p">(</span><span class="s2">&quot;reference_bus&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">ref_bus</span> <span class="ow">or</span> <span class="n">ref_bus</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">model</span><span class="o">.</span><span class="n">_Buses</span><span class="p">:</span>
        <span class="n">ref_bus</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">_Buses</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

    <span class="c1">#Initialize Gurobi Model Parameters, not Variables</span>
    <span class="n">model</span><span class="o">.</span><span class="n">_ReferenceBus</span> <span class="o">=</span> <span class="n">ref_bus</span>
    <span class="n">ref_angle</span> <span class="o">=</span> <span class="n">model_data</span><span class="o">.</span><span class="n">get_system_attr</span><span class="p">(</span><span class="s2">&quot;reference_bus_angle&quot;</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">)</span>
    <span class="n">model</span><span class="o">.</span><span class="n">_ReferenceBusAngle</span> <span class="o">=</span> <span class="n">ref_angle</span>

    <span class="c1"># Time period in minutes</span>
    <span class="n">model</span><span class="o">.</span><span class="n">_TimePeriodLengthMinutes</span> <span class="o">=</span> <span class="n">model_data</span><span class="o">.</span><span class="n">get_system_attr</span><span class="p">(</span>
        <span class="s2">&quot;time_period_length_minutes&quot;</span>
    <span class="p">)</span>

    <span class="c1"># Time period in hours</span>
    <span class="n">model</span><span class="o">.</span><span class="n">_TimePeriodLengthHours</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">_TimePeriodLengthMinutes</span> <span class="o">/</span> <span class="mi">60</span>

    <span class="n">model</span><span class="o">.</span><span class="n">_NumTimePeriods</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">time_keys</span><span class="p">)</span>

    <span class="n">model</span><span class="o">.</span><span class="n">_InitialTime</span> <span class="o">=</span> <span class="mi">1</span>

    <span class="c1"># The periods start with the index 1</span>
    <span class="n">model</span><span class="o">.</span><span class="n">_TimePeriods</span> <span class="o">=</span> <span class="p">[</span>
        <span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">_InitialTime</span><span class="p">,</span> <span class="n">model</span><span class="o">.</span><span class="n">_NumTimePeriods</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
    <span class="p">]</span>
    <span class="n">TimeMapper</span> <span class="o">=</span> <span class="n">uc_time_helper</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">_TimePeriods</span><span class="p">)</span>

    <span class="n">model</span><span class="o">.</span><span class="n">_StageSet</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;Stage_1&quot;</span><span class="p">,</span> <span class="s2">&quot;Stage_2&quot;</span><span class="p">]</span>

    <span class="c1"># The following sets must come from the data files or from an initialization function that uses</span>
    <span class="c1"># a parameter that tells you when the stages end (and that thing needs to come from the data files)</span>

    <span class="n">model</span><span class="o">.</span><span class="n">_CommitmentTimeInStage</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;Stage_1&quot;</span><span class="p">:</span> <span class="n">model</span><span class="o">.</span><span class="n">_TimePeriods</span><span class="p">,</span>
        <span class="s2">&quot;Stage_2&quot;</span><span class="p">:</span> <span class="nb">list</span><span class="p">(),</span>
    <span class="p">}</span>

    <span class="n">model</span><span class="o">.</span><span class="n">_GenerationTimeInStage</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;Stage_1&quot;</span><span class="p">:</span> <span class="nb">list</span><span class="p">(),</span>
        <span class="s2">&quot;Stage_2&quot;</span><span class="p">:</span> <span class="n">model</span><span class="o">.</span><span class="n">_TimePeriods</span><span class="p">,</span>
    <span class="p">}</span>

    <span class="c1"># Network definition</span>

    <span class="n">model</span><span class="o">.</span><span class="n">_TransmissionLines</span> <span class="o">=</span> <span class="n">branch_attrs</span><span class="p">[</span><span class="s2">&quot;names&quot;</span><span class="p">]</span>
    <span class="n">model</span><span class="o">.</span><span class="n">_HVDCLines</span> <span class="o">=</span> <span class="n">dc_branch_attrs</span><span class="p">[</span><span class="s2">&quot;names&quot;</span><span class="p">]</span>

    <span class="n">model</span><span class="o">.</span><span class="n">_BusFrom</span> <span class="o">=</span> <span class="n">tupledict</span><span class="p">(</span><span class="n">branch_attrs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;from_bus&quot;</span><span class="p">,</span> <span class="p">{}))</span>
    <span class="n">model</span><span class="o">.</span><span class="n">_BusTo</span> <span class="o">=</span> <span class="n">tupledict</span><span class="p">(</span><span class="n">branch_attrs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;to_bus&quot;</span><span class="p">,</span> <span class="p">{}))</span>

    <span class="n">model</span><span class="o">.</span><span class="n">_HVDCBusFrom</span> <span class="o">=</span> <span class="n">tupledict</span><span class="p">(</span><span class="n">dc_branch_attrs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;from_bus&quot;</span><span class="p">,</span> <span class="p">{}))</span>

    <span class="n">model</span><span class="o">.</span><span class="n">_HVDCBusTo</span> <span class="o">=</span> <span class="n">tupledict</span><span class="p">(</span><span class="n">dc_branch_attrs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;to_bus&quot;</span><span class="p">,</span> <span class="p">{}))</span>

    <span class="n">model</span><span class="o">.</span><span class="n">_LinesTo</span> <span class="o">=</span> <span class="n">tupledict</span><span class="p">(</span><span class="n">inlet_branches_by_bus</span><span class="p">)</span>
    <span class="n">model</span><span class="o">.</span><span class="n">_LinesFrom</span> <span class="o">=</span> <span class="n">tupledict</span><span class="p">(</span><span class="n">outlet_branches_by_bus</span><span class="p">)</span>

    <span class="n">model</span><span class="o">.</span><span class="n">_HVDCLinesTo</span> <span class="o">=</span> <span class="n">tupledict</span><span class="p">(</span><span class="n">dc_inlet_branches_by_bus</span><span class="p">)</span>
    <span class="n">model</span><span class="o">.</span><span class="n">_HVDCLinesFrom</span> <span class="o">=</span> <span class="n">tupledict</span><span class="p">(</span><span class="n">dc_outlet_branches_by_bus</span><span class="p">)</span>

    <span class="n">model</span><span class="o">.</span><span class="n">_Impedence</span> <span class="o">=</span> <span class="n">tupledict</span><span class="p">(</span><span class="n">branch_attrs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;reactance&quot;</span><span class="p">,</span> <span class="p">{}))</span>

    <span class="n">model</span><span class="o">.</span><span class="n">_ThermalLimit</span> <span class="o">=</span> <span class="n">tupledict</span><span class="p">(</span>
        <span class="n">branch_attrs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;rating_long_term&quot;</span><span class="p">,</span> <span class="p">{})</span>
    <span class="p">)</span>  <span class="c1"># max flow across the line</span>

    <span class="n">model</span><span class="o">.</span><span class="n">_HVDCThermalLimit</span> <span class="o">=</span> <span class="n">tupledict</span><span class="p">(</span>
        <span class="n">dc_branch_attrs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;rating_long_term&quot;</span><span class="p">,</span> <span class="p">{})</span>
    <span class="p">)</span>  <span class="c1"># max flow across the line</span>

    <span class="c1"># default value is False</span>
    <span class="c1"># TiemMapper will automatically add t</span>
    <span class="n">model</span><span class="o">.</span><span class="n">_LineOutOfService</span> <span class="o">=</span> <span class="n">tupledict</span><span class="p">(</span>
        <span class="n">TimeMapper</span><span class="p">(</span>
            <span class="n">branch_attrs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
                <span class="s2">&quot;planned_outage&quot;</span><span class="p">,</span> <span class="p">{</span><span class="n">l</span><span class="p">:</span> <span class="kc">False</span> <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="n">model</span><span class="o">.</span><span class="n">_TransmissionLines</span><span class="p">}</span>
            <span class="p">)</span>
        <span class="p">)</span>
    <span class="p">)</span>

    <span class="n">model</span><span class="o">.</span><span class="n">_HVDCLineOutOfService</span> <span class="o">=</span> <span class="n">tupledict</span><span class="p">(</span>
        <span class="n">TimeMapper</span><span class="p">(</span>
            <span class="n">dc_branch_attrs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
                <span class="s2">&quot;planned_outage&quot;</span><span class="p">,</span> <span class="p">{</span><span class="n">l</span><span class="p">:</span> <span class="kc">False</span> <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="n">model</span><span class="o">.</span><span class="n">_HVDCLines</span><span class="p">}</span>
            <span class="p">)</span>
        <span class="p">)</span>
    <span class="p">)</span>

    <span class="n">_branch_penalties</span> <span class="o">=</span> <span class="n">tupledict</span><span class="p">()</span>
    <span class="n">_md_violation_penalties</span> <span class="o">=</span> <span class="n">branch_attrs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;violation_penalty&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">_md_violation_penalties</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">_md_violation_penalties</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">val</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">_branch_penalties</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">val</span>

                <span class="k">if</span> <span class="n">val</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                        <span class="s2">&quot;Branch </span><span class="si">{}</span><span class="s2"> has a non-positive penalty </span><span class="si">{}</span><span class="s2">, this will &quot;</span>
                        <span class="s2">&quot;cause its limits to be ignored!&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">val</span><span class="p">)</span>
                    <span class="p">)</span>

    <span class="n">model</span><span class="o">.</span><span class="n">_BranchesWithSlack</span> <span class="o">=</span> <span class="n">_branch_penalties</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>

    <span class="n">model</span><span class="o">.</span><span class="n">_BranchLimitPenalty</span> <span class="o">=</span> <span class="n">_branch_penalties</span>

    <span class="c1"># Interfaces</span>
    <span class="n">model</span><span class="o">.</span><span class="n">_Interfaces</span> <span class="o">=</span> <span class="n">interface_attrs</span><span class="p">[</span><span class="s2">&quot;names&quot;</span><span class="p">]</span>
    <span class="n">model</span><span class="o">.</span><span class="n">_InterfaceLines</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">interface_attrs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;lines&quot;</span><span class="p">,</span> <span class="p">{}))</span>

    <span class="n">model</span><span class="o">.</span><span class="n">_InterfaceMinFlow</span> <span class="o">=</span> <span class="n">tupledict</span><span class="p">(</span>
        <span class="n">interface_attrs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;minimum_limit&quot;</span><span class="p">,</span> <span class="p">{})</span>
    <span class="p">)</span>

    <span class="n">model</span><span class="o">.</span><span class="n">_InterfaceMaxFlow</span> <span class="o">=</span> <span class="n">tupledict</span><span class="p">(</span>
        <span class="n">interface_attrs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;maximum_limit&quot;</span><span class="p">,</span> <span class="p">{})</span>
    <span class="p">)</span>

    <span class="k">def</span> <span class="nf">check_min_less_max_interface_flow_limits</span><span class="p">(</span><span class="n">m</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">intfc</span> <span class="ow">in</span> <span class="n">m</span><span class="o">.</span><span class="n">_Interfaces</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">m</span><span class="o">.</span><span class="n">_InterfaceMinFlow</span><span class="p">[</span><span class="n">intfc</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">m</span><span class="o">.</span><span class="n">_InterfaceMaxFlow</span><span class="p">[</span><span class="n">intfc</span><span class="p">]:</span>
                <span class="k">raise</span> <span class="n">ModelError</span><span class="p">(</span>
                    <span class="s2">&quot;Interface </span><span class="si">{}</span><span class="s2"> has a minimum_limit which is greater than &quot;</span>
                    <span class="s2">&quot;the maximum_limit&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">intfc</span><span class="p">)</span>
                <span class="p">)</span>

    <span class="n">check_min_less_max_interface_flow_limits</span><span class="p">(</span><span class="n">model</span><span class="p">)</span>

    <span class="n">_interface_line_orientation_dict</span> <span class="o">=</span> <span class="n">tupledict</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">intfc</span><span class="p">,</span> <span class="n">interface</span> <span class="ow">in</span> <span class="n">interfaces</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="k">for</span> <span class="n">line</span><span class="p">,</span> <span class="n">sign</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span>
                <span class="n">interface</span><span class="p">[</span><span class="s2">&quot;lines&quot;</span><span class="p">],</span> <span class="n">interface</span><span class="p">[</span><span class="s2">&quot;line_orientation&quot;</span><span class="p">]</span>
        <span class="p">):</span>
            <span class="n">_interface_line_orientation_dict</span><span class="p">[</span><span class="n">intfc</span><span class="p">,</span> <span class="n">line</span><span class="p">]</span> <span class="o">=</span> <span class="n">sign</span>

    <span class="n">model</span><span class="o">.</span><span class="n">_InterfaceLineOrientation</span> <span class="o">=</span> <span class="n">_interface_line_orientation_dict</span>

    <span class="n">_interface_penalties</span> <span class="o">=</span> <span class="n">tupledict</span><span class="p">()</span>
    <span class="n">_md_violation_penalties</span> <span class="o">=</span> <span class="n">tupledict</span><span class="p">(</span>
        <span class="n">interface_attrs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;violation_penalty&quot;</span><span class="p">,</span> <span class="p">{})</span>
    <span class="p">)</span>

    <span class="k">if</span> <span class="n">_md_violation_penalties</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">intfc</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">_md_violation_penalties</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">val</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">_interface_penalties</span><span class="p">[</span><span class="n">intfc</span><span class="p">]</span> <span class="o">=</span> <span class="n">val</span>

                <span class="k">if</span> <span class="n">val</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                        <span class="s2">&quot;Interface </span><span class="si">{}</span><span class="s2"> has a non-positive penalty </span><span class="si">{}</span><span class="s2">, this &quot;</span>
                        <span class="s2">&quot;will cause its limits to be ignored!&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                            <span class="n">intfc</span><span class="p">,</span> <span class="n">val</span>
                        <span class="p">)</span>
                    <span class="p">)</span>

    <span class="n">model</span><span class="o">.</span><span class="n">_InterfacesWithSlack</span> <span class="o">=</span> <span class="n">_interface_penalties</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
    <span class="n">model</span><span class="o">.</span><span class="n">_InterfaceLimitPenalty</span> <span class="o">=</span> <span class="n">_interface_penalties</span>

    <span class="c1"># string indentifiers for the set of thermal generators.</span>
    <span class="c1"># and their locations. (S)</span>
    <span class="n">model</span><span class="o">.</span><span class="n">_ThermalGenerators</span> <span class="o">=</span> <span class="n">OrderedSet</span><span class="p">(</span><span class="n">thermal_gen_attrs</span><span class="p">[</span><span class="s2">&quot;names&quot;</span><span class="p">])</span>
    <span class="n">model</span><span class="o">.</span><span class="n">_ThermalGeneratorsAtBus</span> <span class="o">=</span> <span class="n">thermal_gens_by_bus</span>

    <span class="c1"># default type is &#39;C&#39;</span>
    <span class="n">model</span><span class="o">.</span><span class="n">_ThermalGeneratorType</span> <span class="o">=</span> <span class="n">tupledict</span><span class="p">(</span>
        <span class="n">thermal_gen_attrs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
            <span class="s2">&quot;fuel&quot;</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;g&quot;</span><span class="p">:</span> <span class="s2">&quot;C&quot;</span> <span class="k">for</span> <span class="n">g</span> <span class="ow">in</span> <span class="n">model</span><span class="o">.</span><span class="n">_ThermalGenerators</span><span class="p">}</span>
        <span class="p">)</span>
    <span class="p">)</span>

    <span class="k">def</span> <span class="nf">verify_thermal_generator_buses_rule</span><span class="p">(</span><span class="n">m</span><span class="p">):</span>
        <span class="k">assert</span> <span class="nb">set</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">_ThermalGenerators</span><span class="p">)</span> <span class="o">==</span> <span class="p">{</span>
            <span class="n">gen</span> <span class="k">for</span> <span class="n">bus</span> <span class="ow">in</span> <span class="n">m</span><span class="o">.</span><span class="n">_Buses</span> <span class="k">for</span> <span class="n">gen</span> <span class="ow">in</span> <span class="n">m</span><span class="o">.</span><span class="n">_ThermalGeneratorsAtBus</span><span class="p">[</span><span class="n">bus</span><span class="p">]</span>
        <span class="p">}</span>

    <span class="n">verify_thermal_generator_buses_rule</span><span class="p">(</span><span class="n">model</span><span class="p">)</span>
    <span class="n">model</span><span class="o">.</span><span class="n">_QuickStart</span> <span class="o">=</span> <span class="n">tupledict</span><span class="p">(</span>
        <span class="n">thermal_gen_attrs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
            <span class="s2">&quot;fast_start&quot;</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;g&quot;</span><span class="p">:</span> <span class="kc">False</span> <span class="k">for</span> <span class="n">g</span> <span class="ow">in</span> <span class="n">model</span><span class="o">.</span><span class="n">_ThermalGenerators</span><span class="p">}</span>
        <span class="p">)</span>
    <span class="p">)</span>

    <span class="k">def</span> <span class="nf">init_quick_start_generators</span><span class="p">(</span><span class="n">m</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">g</span> <span class="k">for</span> <span class="n">g</span> <span class="ow">in</span> <span class="n">m</span><span class="o">.</span><span class="n">_ThermalGenerators</span> <span class="k">if</span> <span class="n">m</span><span class="o">.</span><span class="n">_QuickStart</span><span class="p">[</span><span class="n">g</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">]</span>

    <span class="n">model</span><span class="o">.</span><span class="n">_QuickStartGenerators</span> <span class="o">=</span> <span class="n">OrderedSet</span><span class="p">(</span>
        <span class="n">init_quick_start_generators</span><span class="p">(</span><span class="n">model</span><span class="p">)</span>
    <span class="p">)</span>

    <span class="c1"># Optionally force a unit to be on/off</span>
    <span class="n">model</span><span class="o">.</span><span class="n">_FixedCommitmentTypes</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="kc">None</span><span class="p">]</span>

    <span class="c1"># TimeMapper will automatically add t key</span>
    <span class="n">model</span><span class="o">.</span><span class="n">_FixedCommitment</span> <span class="o">=</span> <span class="n">tupledict</span><span class="p">(</span>
        <span class="n">TimeMapper</span><span class="p">(</span>
            <span class="n">thermal_gen_attrs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
                <span class="s2">&quot;fixed_commitment&quot;</span><span class="p">,</span> <span class="p">{</span><span class="n">g</span><span class="p">:</span> <span class="kc">None</span> <span class="k">for</span> <span class="n">g</span> <span class="ow">in</span> <span class="n">model</span><span class="o">.</span><span class="n">_ThermalGenerators</span><span class="p">}</span>
            <span class="p">)</span>
        <span class="p">)</span>
    <span class="p">)</span>

    <span class="n">model</span><span class="o">.</span><span class="n">_AllNondispatchableGenerators</span> <span class="o">=</span> <span class="n">OrderedSet</span><span class="p">(</span>
        <span class="n">renewable_gen_attrs</span><span class="p">[</span><span class="s2">&quot;names&quot;</span><span class="p">]</span>
    <span class="p">)</span>
    <span class="n">model</span><span class="o">.</span><span class="n">_NondispatchableGeneratorsAtBus</span> <span class="o">=</span> <span class="n">renewable_gens_by_bus</span>

    <span class="n">model</span><span class="o">.</span><span class="n">_NondispatchableGeneratorType</span> <span class="o">=</span> <span class="n">tupledict</span><span class="p">(</span>
        <span class="n">renewable_gen_attrs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;fuel&quot;</span><span class="p">,</span> <span class="p">{})</span>
    <span class="p">)</span>

    <span class="k">def</span> <span class="nf">verify_renew_generator_buses_rule</span><span class="p">(</span><span class="n">m</span><span class="p">):</span>
        <span class="k">assert</span> <span class="nb">set</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">_AllNondispatchableGenerators</span><span class="p">)</span> <span class="o">==</span> <span class="p">{</span>
            <span class="n">gen</span>
            <span class="k">for</span> <span class="n">bus</span> <span class="ow">in</span> <span class="n">m</span><span class="o">.</span><span class="n">_Buses</span>
            <span class="k">for</span> <span class="n">gen</span> <span class="ow">in</span> <span class="n">m</span><span class="o">.</span><span class="n">_NondispatchableGeneratorsAtBus</span><span class="p">[</span><span class="n">bus</span><span class="p">]</span>
        <span class="p">}</span>

    <span class="n">verify_renew_generator_buses_rule</span><span class="p">(</span><span class="n">model</span><span class="p">)</span>

    <span class="c1"># The global system demand, for each time period. units are MW.</span>
    <span class="c1"># demand as at busses (S) so total demand is derived.</span>
    <span class="c1"># Negative demand is allowed.</span>

    <span class="n">bus_loads</span> <span class="o">=</span> <span class="n">tupledict</span><span class="p">(</span>
        <span class="p">{(</span><span class="n">b</span><span class="p">,</span> <span class="n">t</span><span class="p">):</span> <span class="mi">0</span> <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="n">bus_attrs</span><span class="p">[</span><span class="s2">&quot;names&quot;</span><span class="p">]</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">model</span><span class="o">.</span><span class="n">_TimePeriods</span><span class="p">}</span>
    <span class="p">)</span>

    <span class="k">for</span> <span class="n">lname</span><span class="p">,</span> <span class="n">load</span> <span class="ow">in</span> <span class="n">loads</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="n">load_time</span> <span class="o">=</span> <span class="n">TimeMapper</span><span class="p">(</span><span class="n">load</span><span class="p">[</span><span class="s2">&quot;p_load&quot;</span><span class="p">])</span>
        <span class="n">bus</span> <span class="o">=</span> <span class="n">load</span><span class="p">[</span><span class="s2">&quot;bus&quot;</span><span class="p">]</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">bus</span><span class="p">,</span> <span class="n">tupledict</span><span class="p">):</span>
            <span class="k">assert</span> <span class="n">bus</span><span class="p">[</span><span class="s2">&quot;data_type&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;load_distribution_factor&quot;</span>

            <span class="k">for</span> <span class="n">bn</span><span class="p">,</span> <span class="n">multi</span> <span class="ow">in</span> <span class="n">bus</span><span class="p">[</span><span class="s2">&quot;values&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">model</span><span class="o">.</span><span class="n">_TimePeriods</span><span class="p">:</span>
                    <span class="n">bus_loads</span><span class="p">[</span><span class="n">bn</span><span class="p">,</span> <span class="n">t</span><span class="p">]</span> <span class="o">+=</span> <span class="n">multi</span> <span class="o">*</span> <span class="n">load_time</span><span class="p">[</span><span class="n">t</span><span class="p">]</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">model</span><span class="o">.</span><span class="n">_TimePeriods</span><span class="p">:</span>
                <span class="n">bus_loads</span><span class="p">[</span><span class="n">bus</span><span class="p">,</span> <span class="n">t</span><span class="p">]</span> <span class="o">+=</span> <span class="n">load_time</span><span class="p">[</span><span class="n">t</span><span class="p">]</span>

    <span class="n">model</span><span class="o">.</span><span class="n">_Demand</span> <span class="o">=</span> <span class="n">bus_loads</span>

    <span class="c1"># Sum over demand of buses at each hr of 24 hrs</span>
    <span class="k">def</span> <span class="nf">calculate_total_demand</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">t</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">sum</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">_Demand</span><span class="p">[</span><span class="n">b</span><span class="p">,</span> <span class="n">t</span><span class="p">]</span> <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">_Buses</span><span class="p">))</span>

    <span class="n">model</span><span class="o">.</span><span class="n">_TotalDemand</span> <span class="o">=</span> <span class="n">tupledict</span><span class="p">(</span>
        <span class="p">{</span><span class="n">t</span><span class="p">:</span> <span class="n">calculate_total_demand</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">t</span><span class="p">)</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">model</span><span class="o">.</span><span class="n">_TimePeriods</span><span class="p">}</span>
    <span class="p">)</span>

    <span class="c1"># Warning about negative demand.</span>
    <span class="k">def</span> <span class="nf">warn_about_negative_demand_rule</span><span class="p">(</span><span class="n">m</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="n">m</span><span class="o">.</span><span class="n">_Buses</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">m</span><span class="o">.</span><span class="n">_TimePeriods</span><span class="p">:</span>
                <span class="n">this_demand</span> <span class="o">=</span> <span class="n">m</span><span class="o">.</span><span class="n">_Demand</span><span class="p">[(</span><span class="n">b</span><span class="p">,</span> <span class="n">t</span><span class="p">)]</span>

                <span class="k">if</span> <span class="n">this_demand</span> <span class="o">&lt;</span> <span class="mf">0.0</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                        <span class="s2">&quot;***WARNING: The demand at bus `</span><span class="si">{}</span><span class="s2">` for time period &lt;</span><span class="si">{}</span><span class="s2">&gt; is &quot;</span>
                        <span class="s2">&quot;negative - value </span><span class="si">{:.4f}</span><span class="s2">}; model=</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                            <span class="n">b</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">this_demand</span><span class="p">,</span> <span class="n">m</span><span class="o">.</span><span class="n">_name</span>
                        <span class="p">)</span>
                    <span class="p">)</span>

    <span class="n">warn_about_negative_demand_rule</span><span class="p">(</span><span class="n">model</span><span class="p">)</span>

    <span class="c1"># The global system reserve, for each time period. units are MW.</span>

    <span class="n">reserve_req</span> <span class="o">=</span> <span class="n">tupledict</span><span class="p">(</span>
        <span class="n">TimeMapper</span><span class="p">(</span><span class="n">model_data</span><span class="o">.</span><span class="n">get_system_attr</span><span class="p">(</span><span class="s2">&quot;reserve_requirement&quot;</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">))</span>
    <span class="p">)</span>

    <span class="n">model</span><span class="o">.</span><span class="n">_ReserveRequirement</span> <span class="o">=</span> <span class="n">reserve_req</span>

    <span class="c1">#The minimum number of time periods that a generator must be on-line (off-line) once brought up (down).</span>

    <span class="n">model</span><span class="o">.</span><span class="n">_MinimumUpTime</span> <span class="o">=</span> <span class="n">thermal_gen_attrs</span><span class="p">[</span><span class="s2">&quot;min_up_time&quot;</span><span class="p">]</span>

    <span class="n">model</span><span class="o">.</span><span class="n">_MinimumDownTime</span> <span class="o">=</span> <span class="n">thermal_gen_attrs</span><span class="p">[</span><span class="s2">&quot;min_down_time&quot;</span><span class="p">]</span>

    <span class="c1"># Assert that MUT and MDT are at least 1 in the time units of the model.</span>
    <span class="c1"># Otherwise, turn on/offs may not be enforced correctly.</span>
    <span class="k">def</span> <span class="nf">scale_min_uptime</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">g</span><span class="p">):</span>
        <span class="n">scaled_up_time</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span>
            <span class="n">math</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">_MinimumUpTime</span><span class="p">[</span><span class="n">g</span><span class="p">]</span> <span class="o">/</span> <span class="n">m</span><span class="o">.</span><span class="n">_TimePeriodLengthHours</span><span class="p">)</span>
        <span class="p">)</span>

        <span class="k">return</span> <span class="nb">min</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="n">scaled_up_time</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="n">m</span><span class="o">.</span><span class="n">_NumTimePeriods</span><span class="p">)</span>

    <span class="n">model</span><span class="o">.</span><span class="n">_ScaledMinimumUpTime</span> <span class="o">=</span> <span class="n">tupledict</span><span class="p">(</span>
        <span class="p">{</span><span class="n">g</span><span class="p">:</span> <span class="n">scale_min_uptime</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">g</span><span class="p">)</span> <span class="k">for</span> <span class="n">g</span> <span class="ow">in</span> <span class="n">model</span><span class="o">.</span><span class="n">_ThermalGenerators</span><span class="p">}</span>
    <span class="p">)</span>

    <span class="k">def</span> <span class="nf">scale_min_downtime</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">g</span><span class="p">):</span>
        <span class="n">scaled_down_time</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span>
            <span class="n">math</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">_MinimumDownTime</span><span class="p">[</span><span class="n">g</span><span class="p">]</span> <span class="o">/</span> <span class="n">m</span><span class="o">.</span><span class="n">_TimePeriodLengthHours</span><span class="p">)</span>
        <span class="p">)</span>

        <span class="k">return</span> <span class="nb">min</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="n">scaled_down_time</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="n">m</span><span class="o">.</span><span class="n">_NumTimePeriods</span><span class="p">)</span>

    <span class="n">model</span><span class="o">.</span><span class="n">_ScaledMinimumDownTime</span> <span class="o">=</span> <span class="n">tupledict</span><span class="p">(</span>
        <span class="p">{</span><span class="n">g</span><span class="p">:</span> <span class="n">scale_min_downtime</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">g</span><span class="p">)</span> <span class="k">for</span> <span class="n">g</span> <span class="ow">in</span> <span class="n">model</span><span class="o">.</span><span class="n">_ThermalGenerators</span><span class="p">}</span>
    <span class="p">)</span>


    <span class="c1"># Minimum and maximum generation levels, for each thermal generator. units are MW.</span>

    <span class="k">if</span> <span class="n">renew_costs</span><span class="p">:</span>
        <span class="n">cost_gens</span> <span class="o">=</span> <span class="p">(</span>
                <span class="n">model</span><span class="o">.</span><span class="n">_ThermalGenerators</span> <span class="o">|</span> <span class="n">model</span><span class="o">.</span><span class="n">_AllNondispatchableGenerators</span>
        <span class="p">)</span>
        <span class="n">cost_attrs</span> <span class="o">=</span> <span class="n">model_data</span><span class="o">.</span><span class="n">attributes</span><span class="p">(</span><span class="n">element_type</span><span class="o">=</span><span class="s2">&quot;generator&quot;</span><span class="p">)</span>

    <span class="k">else</span><span class="p">:</span>
        <span class="n">cost_gens</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">_ThermalGenerators</span>
        <span class="n">cost_attrs</span> <span class="o">=</span> <span class="n">thermal_gen_attrs</span>

    <span class="n">model</span><span class="o">.</span><span class="n">_MinimumPowerOutput</span> <span class="o">=</span> <span class="n">TimeMapper</span><span class="p">(</span><span class="n">cost_attrs</span><span class="p">[</span><span class="s2">&quot;p_min&quot;</span><span class="p">])</span>

    <span class="n">model</span><span class="o">.</span><span class="n">_MaximumPowerOutput</span> <span class="o">=</span> <span class="n">TimeMapper</span><span class="p">(</span><span class="n">cost_attrs</span><span class="p">[</span><span class="s2">&quot;p_max&quot;</span><span class="p">])</span>

    <span class="n">model</span><span class="o">.</span><span class="n">_MinimumReactivePowerOutput</span> <span class="o">=</span> <span class="n">tupledict</span><span class="p">(</span>
        <span class="n">TimeMapper</span><span class="p">(</span>
            <span class="n">thermal_gen_attrs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
                <span class="s2">&quot;q_min&quot;</span><span class="p">,</span> <span class="p">{</span><span class="n">g</span><span class="p">:</span> <span class="mi">0</span> <span class="k">for</span> <span class="n">g</span> <span class="ow">in</span> <span class="n">model</span><span class="o">.</span><span class="n">_ThermalGenerators</span><span class="p">}</span>
            <span class="p">)</span>
        <span class="p">)</span>
    <span class="p">)</span>

    <span class="n">model</span><span class="o">.</span><span class="n">_MaximumReactivePowerOutput</span> <span class="o">=</span> <span class="n">tupledict</span><span class="p">(</span>
        <span class="n">TimeMapper</span><span class="p">(</span>
            <span class="n">thermal_gen_attrs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
                <span class="s2">&quot;q_max&quot;</span><span class="p">,</span> <span class="p">{</span><span class="n">g</span><span class="p">:</span> <span class="mi">0</span> <span class="k">for</span> <span class="n">g</span> <span class="ow">in</span> <span class="n">model</span><span class="o">.</span><span class="n">_ThermalGenerators</span><span class="p">}</span>
            <span class="p">)</span>
        <span class="p">)</span>
    <span class="p">)</span>

    <span class="c1"># Wind is similar, but max and min will be equal for non-dispatchable wind</span>

    <span class="n">model</span><span class="o">.</span><span class="n">_MinNondispatchablePower</span> <span class="o">=</span> <span class="n">tupledict</span><span class="p">(</span>
        <span class="n">TimeMapper</span><span class="p">(</span>
            <span class="n">renewable_gen_attrs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
                <span class="s2">&quot;p_min&quot;</span><span class="p">,</span> <span class="p">{</span><span class="n">g</span><span class="p">:</span> <span class="mi">0</span> <span class="k">for</span> <span class="n">g</span> <span class="ow">in</span> <span class="n">model</span><span class="o">.</span><span class="n">_ThermalGenerators</span><span class="p">}</span>
            <span class="p">)</span>
        <span class="p">)</span>
    <span class="p">)</span>

    <span class="n">model</span><span class="o">.</span><span class="n">_MaxNondispatchablePower</span> <span class="o">=</span> <span class="n">tupledict</span><span class="p">(</span>
        <span class="n">TimeMapper</span><span class="p">(</span>
            <span class="n">renewable_gen_attrs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
                <span class="s2">&quot;p_max&quot;</span><span class="p">,</span> <span class="p">{</span><span class="n">g</span><span class="p">:</span> <span class="mi">0</span> <span class="k">for</span> <span class="n">g</span> <span class="ow">in</span> <span class="n">model</span><span class="o">.</span><span class="n">_ThermalGenerators</span><span class="p">}</span>
            <span class="p">)</span>
        <span class="p">)</span>
    <span class="p">)</span>


    <span class="c1"># Generator ramp up/down rates. units are MW/h.</span>
    <span class="c1"># IMPORTANT: Generator ramp limits can exceed</span>
    <span class="c1"># the maximum power output, because it is the</span>
    <span class="c1"># ramp limit over an hour. If the unit can</span>
    <span class="c1"># fully ramp in less than an hour, then this</span>
    <span class="c1"># will occur.</span>

    <span class="c1"># Be sure the generator can ramp between all the p_min/p_max values</span>
    <span class="k">def</span> <span class="nf">ramp_up_validator</span><span class="p">(</span><span class="n">m</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">g</span> <span class="ow">in</span> <span class="n">m</span><span class="o">.</span><span class="n">_ThermalGenerators</span><span class="p">:</span>
            <span class="n">t1</span> <span class="o">=</span> <span class="n">m</span><span class="o">.</span><span class="n">_InitialTime</span>

            <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">m</span><span class="o">.</span><span class="n">_TimePeriods</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">t</span> <span class="o">==</span> <span class="n">t1</span><span class="p">:</span>
                    <span class="k">continue</span>

                <span class="n">diff</span> <span class="o">=</span> <span class="p">(</span>
                        <span class="n">m</span><span class="o">.</span><span class="n">_MinimumPowerOutput</span><span class="p">[</span><span class="n">g</span><span class="p">,</span> <span class="n">t</span><span class="p">]</span>
                        <span class="o">-</span> <span class="n">m</span><span class="o">.</span><span class="n">_MaximumPowerOutput</span><span class="p">[</span><span class="n">g</span><span class="p">,</span> <span class="n">t</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span>
                <span class="p">)</span>

                <span class="k">if</span> <span class="n">m</span><span class="o">.</span><span class="n">_NominalRampUpLimit</span><span class="p">[</span><span class="n">g</span><span class="p">]</span> <span class="o">*</span> <span class="n">m</span><span class="o">.</span><span class="n">_TimePeriodLengthHours</span> <span class="o">&lt;</span> <span class="n">diff</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
                        <span class="s2">&quot;Generator </span><span class="si">{}</span><span class="s2"> has an infeasible ramp up between &quot;</span>
                        <span class="s2">&quot;time periods </span><span class="si">{}</span><span class="s2"> and </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">g</span><span class="p">,</span> <span class="n">t</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">t</span><span class="p">)</span>
                    <span class="p">)</span>

                    <span class="k">return</span> <span class="kc">False</span>
        <span class="k">return</span> <span class="kc">True</span>

    <span class="c1"># Be sure the generator can ramp between all the p_min/p_max values</span>
    <span class="k">def</span> <span class="nf">ramp_down_validator</span><span class="p">(</span><span class="n">m</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">g</span> <span class="ow">in</span> <span class="n">m</span><span class="o">.</span><span class="n">_ThermalGenerators</span><span class="p">:</span>
            <span class="n">t1</span> <span class="o">=</span> <span class="n">m</span><span class="o">.</span><span class="n">_InitialTime</span>
            <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">m</span><span class="o">.</span><span class="n">_TimePeriods</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">t</span> <span class="o">==</span> <span class="n">t1</span><span class="p">:</span>
                    <span class="k">continue</span>

                <span class="n">diff</span> <span class="o">=</span> <span class="p">(</span>
                        <span class="n">m</span><span class="o">.</span><span class="n">_MinimumPowerOutput</span><span class="p">[</span><span class="n">g</span><span class="p">,</span> <span class="n">t</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span>
                        <span class="o">-</span> <span class="n">m</span><span class="o">.</span><span class="n">_MaximumPowerOutput</span><span class="p">[</span><span class="n">g</span><span class="p">,</span> <span class="n">t</span><span class="p">]</span>
                <span class="p">)</span>

                <span class="k">if</span> <span class="p">(</span>
                        <span class="n">m</span><span class="o">.</span><span class="n">_NominalRampDownLimit</span><span class="p">[</span><span class="n">g</span><span class="p">]</span> <span class="o">*</span> <span class="n">m</span><span class="o">.</span><span class="n">_TimePeriodLengthHours</span>
                        <span class="o">&lt;</span> <span class="n">diff</span>
                <span class="p">):</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
                        <span class="s2">&quot;Generator </span><span class="si">{}</span><span class="s2"> has an infeasible ramp down between time &quot;</span>
                        <span class="s2">&quot;periods </span><span class="si">{}</span><span class="s2"> and </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">g</span><span class="p">,</span> <span class="n">t</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">t</span><span class="p">)</span>
                    <span class="p">)</span>

                    <span class="k">return</span> <span class="kc">False</span>

        <span class="k">return</span> <span class="kc">True</span>

    <span class="c1"># Limits for normal time periods</span>
    <span class="n">model</span><span class="o">.</span><span class="n">_NominalRampUpLimit</span> <span class="o">=</span> <span class="n">thermal_gen_attrs</span><span class="p">[</span><span class="s2">&quot;ramp_up_60min&quot;</span><span class="p">]</span>

    <span class="n">model</span><span class="o">.</span><span class="n">_NominalRampDownLimit</span> <span class="o">=</span> <span class="n">thermal_gen_attrs</span><span class="p">[</span><span class="s2">&quot;ramp_down_60min&quot;</span><span class="p">]</span>

    <span class="n">ramp_up_validator</span><span class="p">(</span><span class="n">model</span><span class="p">)</span>
    <span class="n">ramp_down_validator</span><span class="p">(</span><span class="n">model</span><span class="p">)</span>

    <span class="c1"># Unit on state at t=0 (initial condition). #</span>

    <span class="c1"># if positive, the number of hours prior to (and including) t=0 that the unit has been on.</span>
    <span class="c1"># if negative, the number of hours prior to (and including) t=0 that the unit has been off.</span>
    <span class="c1"># the value cannot be 0, by definition.</span>

    <span class="n">model</span><span class="o">.</span><span class="n">_UnitOnT0State</span> <span class="o">=</span> <span class="n">thermal_gen_attrs</span><span class="p">[</span><span class="s2">&quot;initial_status&quot;</span><span class="p">]</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="nb">all</span><span class="p">([</span><span class="n">i</span> <span class="o">!=</span> <span class="mi">0</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">model</span><span class="o">.</span><span class="n">_UnitOnT0State</span><span class="o">.</span><span class="n">values</span><span class="p">()]):</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;The Unit on status value must be nonzero&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">t0_unit_on_rule</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">g</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">int</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">_UnitOnT0State</span><span class="p">[</span><span class="n">g</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mf">0.0</span><span class="p">)</span>

    <span class="n">model</span><span class="o">.</span><span class="n">_UnitOnT0</span> <span class="o">=</span> <span class="n">tupledict</span><span class="p">(</span>
        <span class="p">{</span><span class="n">g</span><span class="p">:</span> <span class="n">t0_unit_on_rule</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">g</span><span class="p">)</span> <span class="k">for</span> <span class="n">g</span> <span class="ow">in</span> <span class="n">model</span><span class="o">.</span><span class="n">_ThermalGenerators</span><span class="p">}</span>
    <span class="p">)</span>

    <span class="c1"># The number of time periods that a generator must initally on-line (off-line) due to</span>
    <span class="c1"># its minimum up time (down time) constraint.</span>

    <span class="k">def</span> <span class="nf">initial_time_periods_online_rule</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">g</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">m</span><span class="o">.</span><span class="n">_UnitOnT0</span><span class="p">[</span><span class="n">g</span><span class="p">]:</span>
            <span class="k">return</span> <span class="mi">0</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="nb">int</span><span class="p">(</span>
                <span class="nb">min</span><span class="p">(</span>
                    <span class="n">m</span><span class="o">.</span><span class="n">_NumTimePeriods</span><span class="p">,</span>
                    <span class="nb">round</span><span class="p">(</span>
                        <span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">m</span><span class="o">.</span><span class="n">_MinimumUpTime</span><span class="p">[</span><span class="n">g</span><span class="p">]</span> <span class="o">-</span> <span class="n">m</span><span class="o">.</span><span class="n">_UnitOnT0State</span><span class="p">[</span><span class="n">g</span><span class="p">])</span>
                        <span class="o">/</span> <span class="n">m</span><span class="o">.</span><span class="n">_TimePeriodLengthHours</span>
                    <span class="p">),</span>
                <span class="p">)</span>
            <span class="p">)</span>

    <span class="n">model</span><span class="o">.</span><span class="n">_InitialTimePeriodsOnLine</span> <span class="o">=</span> <span class="n">tupledict</span><span class="p">(</span>
        <span class="p">{</span>
            <span class="n">g</span><span class="p">:</span> <span class="n">initial_time_periods_online_rule</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">g</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">g</span> <span class="ow">in</span> <span class="n">model</span><span class="o">.</span><span class="n">_ThermalGenerators</span>
        <span class="p">}</span>
    <span class="p">)</span>

    <span class="k">def</span> <span class="nf">initial_time_periods_offline_rule</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">g</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">m</span><span class="o">.</span><span class="n">_UnitOnT0</span><span class="p">[</span><span class="n">g</span><span class="p">]:</span>
            <span class="k">return</span> <span class="mi">0</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="nb">int</span><span class="p">(</span>
                <span class="nb">min</span><span class="p">(</span>
                    <span class="n">m</span><span class="o">.</span><span class="n">_NumTimePeriods</span><span class="p">,</span>
                    <span class="nb">round</span><span class="p">(</span>
                        <span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">m</span><span class="o">.</span><span class="n">_MinimumDownTime</span><span class="p">[</span><span class="n">g</span><span class="p">]</span> <span class="o">+</span> <span class="n">m</span><span class="o">.</span><span class="n">_UnitOnT0State</span><span class="p">[</span><span class="n">g</span><span class="p">])</span>
                        <span class="o">/</span> <span class="n">m</span><span class="o">.</span><span class="n">_TimePeriodLengthHours</span>
                    <span class="p">),</span>
                <span class="p">)</span>
            <span class="p">)</span>

    <span class="n">model</span><span class="o">.</span><span class="n">_InitialTimePeriodsOffLine</span> <span class="o">=</span> <span class="n">tupledict</span><span class="p">(</span>
        <span class="p">{</span>
            <span class="n">g</span><span class="p">:</span> <span class="n">initial_time_periods_offline_rule</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">g</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">g</span> <span class="ow">in</span> <span class="n">model</span><span class="o">.</span><span class="n">_ThermalGenerators</span>
        <span class="p">}</span>
    <span class="p">)</span>

    <span class="c1"># Ensure that the must-run flag and the t0 state are consistent. in partcular, make</span>
    <span class="c1"># sure that the unit has satisifed its minimum down time condition if UnitOnT0 is negative.</span>

    <span class="k">def</span> <span class="nf">verify_must_run_t0_state_consistency_rule</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">g</span><span class="p">):</span>
        <span class="n">t0_state</span> <span class="o">=</span> <span class="n">m</span><span class="o">.</span><span class="n">_UnitOnT0State</span><span class="p">[</span><span class="n">g</span><span class="p">]</span> <span class="o">/</span> <span class="n">m</span><span class="o">.</span><span class="n">_TimePeriodLengthHours</span>
        <span class="k">if</span> <span class="n">t0_state</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">min_down_time</span> <span class="o">=</span> <span class="n">m</span><span class="o">.</span><span class="n">_ScaledMinimumDownTime</span><span class="p">[</span><span class="n">g</span><span class="p">]</span>
            <span class="k">if</span> <span class="nb">abs</span><span class="p">(</span><span class="n">t0_state</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">min_down_time</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span>
                        <span class="n">m</span><span class="o">.</span><span class="n">_TimePeriods</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                        <span class="n">m</span><span class="o">.</span><span class="n">_InitialTimePeriodsOffLine</span><span class="p">[</span><span class="n">g</span><span class="p">]</span> <span class="o">+</span> <span class="n">m</span><span class="o">.</span><span class="n">_TimePeriods</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                <span class="p">):</span>
                    <span class="n">fixed_commitment</span> <span class="o">=</span> <span class="n">m</span><span class="o">.</span><span class="n">_FixedCommitment</span><span class="p">[</span><span class="n">g</span><span class="p">,</span> <span class="n">t</span><span class="p">]</span>
                    <span class="k">if</span> <span class="p">(</span><span class="n">fixed_commitment</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span>
                            <span class="n">fixed_commitment</span> <span class="o">==</span> <span class="mi">1</span>
                    <span class="p">):</span>
                        <span class="nb">print</span><span class="p">(</span>
                            <span class="s2">&quot;DATA ERROR: The generator </span><span class="si">%s</span><span class="s2"> has been flagged as must-run at time </span><span class="si">%d</span><span class="s2">, but its T0 state=</span><span class="si">%d</span><span class="s2"> is inconsistent with its minimum down time=</span><span class="si">%d</span><span class="s2">&quot;</span>
                            <span class="o">%</span> <span class="p">(</span><span class="n">g</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">t0_state</span><span class="p">,</span> <span class="n">min_down_time</span><span class="p">)</span>
                        <span class="p">)</span>
                        <span class="k">return</span> <span class="kc">False</span>
        <span class="k">else</span><span class="p">:</span>  <span class="c1"># t0_state &gt; 0</span>
            <span class="n">min_up_time</span> <span class="o">=</span> <span class="n">m</span><span class="o">.</span><span class="n">_ScaledMinimumUpTime</span><span class="p">[</span><span class="n">g</span><span class="p">]</span>
            <span class="k">if</span> <span class="nb">abs</span><span class="p">(</span><span class="n">t0_state</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">min_up_time</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span>
                        <span class="n">m</span><span class="o">.</span><span class="n">_TimePeriods</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                        <span class="n">m</span><span class="o">.</span><span class="n">_InitialTimePeriodsOnLine</span><span class="p">[</span><span class="n">g</span><span class="p">]</span> <span class="o">+</span> <span class="n">m</span><span class="o">.</span><span class="n">_TimePeriods</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                <span class="p">):</span>
                    <span class="n">fixed_commitment</span> <span class="o">=</span> <span class="n">m</span><span class="o">.</span><span class="n">_FixedCommitment</span><span class="p">[</span><span class="n">g</span><span class="p">,</span> <span class="n">t</span><span class="p">]</span>
                    <span class="k">if</span> <span class="p">(</span><span class="n">fixed_commitment</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span>
                            <span class="n">fixed_commitment</span> <span class="o">==</span> <span class="mi">0</span>
                    <span class="p">):</span>
                        <span class="nb">print</span><span class="p">(</span>
                            <span class="s2">&quot;DATA ERROR: The generator </span><span class="si">%s</span><span class="s2"> has been flagged as off at time </span><span class="si">%d</span><span class="s2">, but its T0 state=</span><span class="si">%d</span><span class="s2"> is inconsistent with its minimum up time=</span><span class="si">%d</span><span class="s2">&quot;</span>
                            <span class="o">%</span> <span class="p">(</span><span class="n">g</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">t0_state</span><span class="p">,</span> <span class="n">min_up_time</span><span class="p">)</span>
                        <span class="p">)</span>
                        <span class="k">return</span> <span class="kc">False</span>
        <span class="k">return</span> <span class="kc">True</span>

    <span class="n">model</span><span class="o">.</span><span class="n">_InitialTimePeriodsOnLine</span> <span class="o">=</span> <span class="n">tupledict</span><span class="p">(</span>
        <span class="p">{</span>
            <span class="n">g</span><span class="p">:</span> <span class="n">initial_time_periods_online_rule</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">g</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">g</span> <span class="ow">in</span> <span class="n">model</span><span class="o">.</span><span class="n">_ThermalGenerators</span>
        <span class="p">}</span>
    <span class="p">)</span>
    <span class="n">model</span><span class="o">.</span><span class="n">_InitialTimePeriodsOffLine</span> <span class="o">=</span> <span class="n">tupledict</span><span class="p">(</span>
        <span class="p">{</span>
            <span class="n">g</span><span class="p">:</span> <span class="n">initial_time_periods_offline_rule</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">g</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">g</span> <span class="ow">in</span> <span class="n">model</span><span class="o">.</span><span class="n">_ThermalGenerators</span>
        <span class="p">}</span>
    <span class="p">)</span>
    <span class="n">model</span><span class="o">.</span><span class="n">_VerifyMustRunT0StateConsistency</span> <span class="o">=</span> <span class="n">tupledict</span><span class="p">(</span>
        <span class="p">{</span>
            <span class="n">g</span><span class="p">:</span> <span class="n">verify_must_run_t0_state_consistency_rule</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">g</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">g</span> <span class="ow">in</span> <span class="n">model</span><span class="o">.</span><span class="n">_ThermalGenerators</span>
        <span class="p">}</span>
    <span class="p">)</span>

    <span class="c1"># For future shutdowns/startups beyond the time-horizon</span>
    <span class="c1"># Like UnitOnT0State, a postive quantity means the generator</span>
    <span class="c1"># *will start* in &#39;future_status&#39; hours, and a negative quantity</span>
    <span class="c1"># means the generator *will stop* in -(&#39;future_status&#39;) hours.</span>
    <span class="c1"># The default of 0 means we have no information</span>
    <span class="n">model</span><span class="o">.</span><span class="n">_FutureStatus</span> <span class="o">=</span> <span class="n">tupledict</span><span class="p">(</span>
        <span class="n">thermal_gen_attrs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
            <span class="s2">&quot;future_status&quot;</span><span class="p">,</span> <span class="p">{</span><span class="n">g</span><span class="p">:</span> <span class="mi">0</span> <span class="k">for</span> <span class="n">g</span> <span class="ow">in</span> <span class="n">model</span><span class="o">.</span><span class="n">_ThermalGenerators</span><span class="p">}</span>
        <span class="p">)</span>
    <span class="p">)</span>

    <span class="k">def</span> <span class="nf">time_periods_since_last_shutdown_rule</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">g</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">m</span><span class="o">.</span><span class="n">_UnitOnT0</span><span class="p">[</span><span class="n">g</span><span class="p">]:</span>
            <span class="c1"># longer than any time-horizon we&#39;d consider</span>
            <span class="k">return</span> <span class="mi">10000</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="nb">int</span><span class="p">(</span>
                <span class="n">math</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="o">-</span><span class="n">m</span><span class="o">.</span><span class="n">_UnitOnT0State</span><span class="p">[</span><span class="n">g</span><span class="p">]</span> <span class="o">/</span> <span class="n">m</span><span class="o">.</span><span class="n">_TimePeriodLengthHours</span><span class="p">)</span>
            <span class="p">)</span>

    <span class="n">model</span><span class="o">.</span><span class="n">_TimePeriodsSinceShutdown</span> <span class="o">=</span> <span class="n">tupledict</span><span class="p">(</span>
        <span class="p">{</span>
            <span class="n">g</span><span class="p">:</span> <span class="n">time_periods_since_last_shutdown_rule</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">g</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">g</span> <span class="ow">in</span> <span class="n">model</span><span class="o">.</span><span class="n">_ThermalGenerators</span>
        <span class="p">}</span>
    <span class="p">)</span>

    <span class="k">def</span> <span class="nf">time_periods_before_startup_rule</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">g</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">m</span><span class="o">.</span><span class="n">_FutureStatus</span><span class="p">[</span><span class="n">g</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="c1"># longer than any time-horizon we&#39;d consider</span>
            <span class="k">return</span> <span class="mi">10000</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="nb">int</span><span class="p">(</span>
                <span class="n">math</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">_FutureStatus</span><span class="p">[</span><span class="n">g</span><span class="p">]</span> <span class="o">/</span> <span class="n">m</span><span class="o">.</span><span class="n">_TimePeriodLengthHours</span><span class="p">)</span>
            <span class="p">)</span>

    <span class="n">model</span><span class="o">.</span><span class="n">_TimePeriodsBeforeStartup</span> <span class="o">=</span> <span class="n">tupledict</span><span class="p">(</span>
        <span class="p">{</span>
            <span class="n">g</span><span class="p">:</span> <span class="n">time_periods_before_startup_rule</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">g</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">g</span> <span class="ow">in</span> <span class="n">model</span><span class="o">.</span><span class="n">_ThermalGenerators</span>
        <span class="p">}</span>
    <span class="p">)</span>

    <span class="c1"># Startup/shutdown curves for each generator.</span>
    <span class="c1"># These are specified in the same time scales</span>
    <span class="c1"># as &#39;time_period_length_minutes&#39; and other</span>
    <span class="c1"># time-vary quantities.</span>


    <span class="k">def</span> <span class="nf">startup_curve_init_rule</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">g</span><span class="p">):</span>
        <span class="n">startup_curve</span> <span class="o">=</span> <span class="n">thermal_gens</span><span class="p">[</span><span class="n">g</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;startup_curve&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">startup_curve</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">()</span>

        <span class="n">min_down_time</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span>
            <span class="n">math</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">_MinimumDownTime</span><span class="p">[</span><span class="n">g</span><span class="p">]</span> <span class="o">/</span> <span class="n">m</span><span class="o">.</span><span class="n">_TimePeriodLengthHours</span><span class="p">)</span>
        <span class="p">)</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">startup_curve</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">min_down_time</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
                <span class="s2">&quot;Truncating startup_curve longer than scaled minimum down &quot;</span>
                <span class="s2">&quot;time </span><span class="si">{}</span><span class="s2"> for generator </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">min_down_time</span><span class="p">,</span> <span class="n">g</span><span class="p">)</span>
            <span class="p">)</span>

        <span class="k">return</span> <span class="n">startup_curve</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">min_down_time</span><span class="p">]</span>

    <span class="n">model</span><span class="o">.</span><span class="n">_StartupCurve</span> <span class="o">=</span> <span class="p">{</span>
        <span class="n">g</span><span class="p">:</span> <span class="n">startup_curve_init_rule</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">g</span><span class="p">)</span> <span class="k">for</span> <span class="n">g</span> <span class="ow">in</span> <span class="n">model</span><span class="o">.</span><span class="n">_ThermalGenerators</span>
    <span class="p">}</span>

    <span class="k">def</span> <span class="nf">shutdown_curve_init_rule</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">g</span><span class="p">):</span>
        <span class="n">shutdown_curve</span> <span class="o">=</span> <span class="n">thermal_gens</span><span class="p">[</span><span class="n">g</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;shutdown_curve&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">shutdown_curve</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">()</span>

        <span class="n">min_down_time</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span>
            <span class="n">math</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">_MinimumDownTime</span><span class="p">[</span><span class="n">g</span><span class="p">]</span> <span class="o">/</span> <span class="n">m</span><span class="o">.</span><span class="n">_TimePeriodLengthHours</span><span class="p">)</span>
        <span class="p">)</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">shutdown_curve</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">min_down_time</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
                <span class="s2">&quot;Truncating shutdown_curve longer than scaled minimum down &quot;</span>
                <span class="s2">&quot;time </span><span class="si">{}</span><span class="s2"> for generator </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">min_down_time</span><span class="p">,</span> <span class="n">g</span><span class="p">)</span>
            <span class="p">)</span>

        <span class="k">return</span> <span class="n">shutdown_curve</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">min_down_time</span><span class="p">]</span>

    <span class="n">model</span><span class="o">.</span><span class="n">_ShutdownCurve</span> <span class="o">=</span> <span class="p">{</span>
        <span class="n">g</span><span class="p">:</span> <span class="n">shutdown_curve_init_rule</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">g</span><span class="p">)</span> <span class="k">for</span> <span class="n">g</span> <span class="ow">in</span> <span class="n">model</span><span class="o">.</span><span class="n">_ThermalGenerators</span>
    <span class="p">}</span>

    <span class="c1"># Generator power output at t=0 (initial condition). units are MW.</span>

    <span class="k">def</span> <span class="nf">power_generated_t0_validator</span><span class="p">(</span><span class="n">m</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">g</span> <span class="ow">in</span> <span class="n">m</span><span class="o">.</span><span class="n">_ThermalGenerators</span><span class="p">:</span>
            <span class="n">v</span> <span class="o">=</span> <span class="n">m</span><span class="o">.</span><span class="n">_PowerGeneratedT0</span><span class="p">[</span><span class="n">g</span><span class="p">]</span>
            <span class="n">t</span> <span class="o">=</span> <span class="n">m</span><span class="o">.</span><span class="n">_TimePeriods</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

            <span class="k">if</span> <span class="n">m</span><span class="o">.</span><span class="n">_UnitOnT0</span><span class="p">[</span><span class="n">g</span><span class="p">]:</span>
                <span class="n">v_less_max</span> <span class="o">=</span> <span class="p">(</span>
                        <span class="n">v</span>
                        <span class="o">&lt;=</span> <span class="n">m</span><span class="o">.</span><span class="n">_MaximumPowerOutput</span><span class="p">[</span><span class="n">g</span><span class="p">,</span> <span class="n">t</span><span class="p">]</span>
                        <span class="o">+</span> <span class="n">m</span><span class="o">.</span><span class="n">_NominalRampDownLimit</span><span class="p">[</span><span class="n">g</span><span class="p">]</span> <span class="o">*</span> <span class="n">m</span><span class="o">.</span><span class="n">_TimePeriodLengthHours</span>
                <span class="p">)</span>

                <span class="k">if</span> <span class="ow">not</span> <span class="n">v_less_max</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
                        <span class="s2">&quot;Generator </span><span class="si">{}</span><span class="s2"> has more output at T0 than is &quot;</span>
                        <span class="s2">&quot;feasible to ramp down to&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">g</span><span class="p">)</span>
                    <span class="p">)</span>
                    <span class="k">return</span> <span class="kc">False</span>

                <span class="n">v_greater_min</span> <span class="o">=</span> <span class="p">(</span>
                        <span class="n">v</span>
                        <span class="o">&gt;=</span> <span class="n">m</span><span class="o">.</span><span class="n">_MinimumPowerOutput</span><span class="p">[</span><span class="n">g</span><span class="p">,</span> <span class="n">t</span><span class="p">]</span>
                        <span class="o">-</span> <span class="n">m</span><span class="o">.</span><span class="n">_NominalRampUpLimit</span><span class="p">[</span><span class="n">g</span><span class="p">]</span> <span class="o">*</span> <span class="n">m</span><span class="o">.</span><span class="n">_TimePeriodLengthHours</span>
                <span class="p">)</span>

                <span class="k">if</span> <span class="ow">not</span> <span class="n">v_less_max</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
                        <span class="s2">&quot;Generator </span><span class="si">{}</span><span class="s2"> has less output at T0 than is &quot;</span>
                        <span class="s2">&quot;feasible to ramp up to&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">g</span><span class="p">)</span>
                    <span class="p">)</span>
                    <span class="k">return</span> <span class="kc">False</span>

                <span class="k">return</span> <span class="kc">True</span>

            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># Generator was off, but could have residual power due to</span>
                <span class="c1"># start-up/shut-down curve. Therefore, do not be too picky</span>
                <span class="c1"># as the value doesn&#39;t affect any constraints directly</span>
                <span class="k">return</span> <span class="kc">True</span>

    <span class="n">model</span><span class="o">.</span><span class="n">_PowerGeneratedT0</span> <span class="o">=</span> <span class="n">thermal_gen_attrs</span><span class="p">[</span><span class="s2">&quot;initial_p_output&quot;</span><span class="p">]</span>
    <span class="n">power_generated_t0_validator</span><span class="p">(</span><span class="n">model</span><span class="p">)</span>

    <span class="c1"># Limits for time periods in which generators are brought on or off-line.</span>
    <span class="c1"># must be no less than the generator minimum output.</span>
    <span class="k">def</span> <span class="nf">ramp_limit_validator</span><span class="p">(</span><span class="n">m</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">g</span> <span class="ow">in</span> <span class="n">model</span><span class="o">.</span><span class="n">_ThermalGenerators</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">model</span><span class="o">.</span><span class="n">_TimePeriods</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="p">[</span>
                    <span class="n">model</span><span class="o">.</span><span class="n">_StartupRampLimit</span><span class="p">[</span><span class="n">g</span><span class="p">,</span> <span class="n">t</span><span class="p">],</span>
                    <span class="n">model</span><span class="o">.</span><span class="n">_ShutdownRampLimit</span><span class="p">[</span><span class="n">g</span><span class="p">,</span> <span class="n">t</span><span class="p">],</span>
                    <span class="n">model</span><span class="o">.</span><span class="n">_ScaledStartupRampLimit</span><span class="p">[</span><span class="n">g</span><span class="p">,</span> <span class="n">t</span><span class="p">],</span>
                    <span class="n">model</span><span class="o">.</span><span class="n">_ScaledShutdownRampLimit</span><span class="p">[</span><span class="n">g</span><span class="p">,</span> <span class="n">t</span><span class="p">],</span>
                <span class="p">]:</span>
                    <span class="k">if</span> <span class="n">v</span> <span class="o">&lt;</span> <span class="n">m</span><span class="o">.</span><span class="n">_MinimumPowerOutput</span><span class="p">[</span><span class="n">g</span><span class="p">,</span> <span class="n">t</span><span class="p">]:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
                            <span class="s2">&quot;Scaled/Not Scaled Start Up/Shut Down Ramp Limit is less than the minimum power output for power </span><span class="si">{}</span><span class="s2"> at time </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                                <span class="n">g</span><span class="p">,</span> <span class="n">t</span>
                            <span class="p">)</span>
                        <span class="p">)</span>
                        <span class="k">return</span> <span class="kc">False</span>
        <span class="k">return</span> <span class="kc">True</span>

    <span class="c1"># These defaults follow what is in most market manuals</span>
    <span class="c1"># We scale this for the time period below</span>
    <span class="k">def</span> <span class="nf">startup_ramp_default</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">g</span><span class="p">,</span> <span class="n">t</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">m</span><span class="o">.</span><span class="n">_MinimumPowerOutput</span><span class="p">[</span><span class="n">g</span><span class="p">,</span> <span class="n">t</span><span class="p">]</span> <span class="o">+</span> <span class="n">m</span><span class="o">.</span><span class="n">_NominalRampUpLimit</span><span class="p">[</span><span class="n">g</span><span class="p">]</span> <span class="o">/</span> <span class="mf">2.0</span>

    <span class="c1"># Shutdown is based on the last period *on*</span>
    <span class="k">def</span> <span class="nf">shutdown_ramp_default</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">g</span><span class="p">,</span> <span class="n">t</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">m</span><span class="o">.</span><span class="n">_MinimumPowerOutput</span><span class="p">[</span><span class="n">g</span><span class="p">,</span> <span class="n">t</span><span class="p">]</span> <span class="o">+</span> <span class="n">m</span><span class="o">.</span><span class="n">_NominalRampDownLimit</span><span class="p">[</span><span class="n">g</span><span class="p">]</span> <span class="o">/</span> <span class="mf">2.0</span>

    <span class="n">startup_ramp_default_dict</span> <span class="o">=</span> <span class="n">tupledict</span><span class="p">(</span>
        <span class="p">{</span>
            <span class="p">(</span><span class="n">g</span><span class="p">,</span> <span class="n">t</span><span class="p">):</span> <span class="n">startup_ramp_default</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">g</span><span class="p">,</span> <span class="n">t</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">g</span> <span class="ow">in</span> <span class="n">model</span><span class="o">.</span><span class="n">_ThermalGenerators</span>
            <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">model</span><span class="o">.</span><span class="n">_TimePeriods</span>
        <span class="p">}</span>
    <span class="p">)</span>
    <span class="n">shutdown_ramp_default_dict</span> <span class="o">=</span> <span class="n">tupledict</span><span class="p">(</span>
        <span class="p">{</span>
            <span class="p">(</span><span class="n">g</span><span class="p">,</span> <span class="n">t</span><span class="p">):</span> <span class="n">shutdown_ramp_default</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">g</span><span class="p">,</span> <span class="n">t</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">g</span> <span class="ow">in</span> <span class="n">model</span><span class="o">.</span><span class="n">_ThermalGenerators</span>
            <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">model</span><span class="o">.</span><span class="n">_TimePeriods</span>
        <span class="p">}</span>
    <span class="p">)</span>

    <span class="n">startupramplimit</span> <span class="o">=</span> <span class="n">thermal_gen_attrs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;startup_capacity&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">startupramplimit</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">startupramplimit</span> <span class="o">=</span> <span class="p">{</span>
            <span class="p">(</span><span class="n">g</span><span class="p">,</span> <span class="n">t</span><span class="p">):</span> <span class="n">startup_ramp_default</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">g</span><span class="p">,</span> <span class="n">t</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">g</span> <span class="ow">in</span> <span class="n">model</span><span class="o">.</span><span class="n">_ThermalGenerators</span>
            <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">model</span><span class="o">.</span><span class="n">_TimePeriods</span>
        <span class="p">}</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">startupramplimit</span> <span class="o">=</span> <span class="n">TimeMapper</span><span class="p">(</span><span class="n">startupramplimit</span><span class="p">)</span>

    <span class="n">model</span><span class="o">.</span><span class="n">_StartupRampLimit</span> <span class="o">=</span> <span class="n">tupledict</span><span class="p">(</span><span class="n">startupramplimit</span><span class="p">)</span>

    <span class="n">shutdownramplimit</span> <span class="o">=</span> <span class="n">thermal_gen_attrs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;shutdown_capacity&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">shutdownramplimit</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">shutdownramplimit</span> <span class="o">=</span> <span class="p">{</span>
            <span class="p">(</span><span class="n">g</span><span class="p">,</span> <span class="n">t</span><span class="p">):</span> <span class="n">shutdown_ramp_default</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">g</span><span class="p">,</span> <span class="n">t</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">g</span> <span class="ow">in</span> <span class="n">model</span><span class="o">.</span><span class="n">_ThermalGenerators</span>
            <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">model</span><span class="o">.</span><span class="n">_TimePeriods</span>
        <span class="p">}</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">shutdownramplimit</span> <span class="o">=</span> <span class="n">TimeMapper</span><span class="p">(</span><span class="n">shutdownramplimit</span><span class="p">)</span>

    <span class="n">model</span><span class="o">.</span><span class="n">_ShutdownRampLimit</span> <span class="o">=</span> <span class="n">tupledict</span><span class="p">(</span><span class="n">shutdownramplimit</span><span class="p">)</span>

    <span class="c1"># These get used in the basic UC constraints, which implicity assume RU, RD &lt;= Pmax</span>
    <span class="c1"># Ramping constraints look backward, so these will accordingly as well</span>
    <span class="c1"># NOTES: can&#39;t ramp up higher than the current pmax from the previous value</span>
    <span class="c1">#        can&#39;t ramp down more than the pmax from the prior time period</span>
    <span class="k">def</span> <span class="nf">scale_ramp_up</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">g</span><span class="p">,</span> <span class="n">t</span><span class="p">):</span>
        <span class="n">temp</span> <span class="o">=</span> <span class="n">m</span><span class="o">.</span><span class="n">_NominalRampUpLimit</span><span class="p">[</span><span class="n">g</span><span class="p">]</span> <span class="o">*</span> <span class="n">m</span><span class="o">.</span><span class="n">_TimePeriodLengthHours</span>

        <span class="k">if</span> <span class="n">temp</span> <span class="o">&gt;</span> <span class="n">m</span><span class="o">.</span><span class="n">_MaximumPowerOutput</span><span class="p">[</span><span class="n">g</span><span class="p">,</span> <span class="n">t</span><span class="p">]:</span>
            <span class="k">return</span> <span class="n">m</span><span class="o">.</span><span class="n">_MaximumPowerOutput</span><span class="p">[</span><span class="n">g</span><span class="p">,</span> <span class="n">t</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">temp</span>

    <span class="n">model</span><span class="o">.</span><span class="n">_ScaledNominalRampUpLimit</span> <span class="o">=</span> <span class="n">tupledict</span><span class="p">(</span>
        <span class="p">{</span>
            <span class="p">(</span><span class="n">g</span><span class="p">,</span> <span class="n">t</span><span class="p">):</span> <span class="n">scale_ramp_up</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">g</span><span class="p">,</span> <span class="n">t</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">g</span> <span class="ow">in</span> <span class="n">model</span><span class="o">.</span><span class="n">_ThermalGenerators</span>
            <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">model</span><span class="o">.</span><span class="n">_TimePeriods</span>
        <span class="p">}</span>
    <span class="p">)</span>

    <span class="k">def</span> <span class="nf">scale_ramp_down</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">g</span><span class="p">,</span> <span class="n">t</span><span class="p">):</span>
        <span class="n">temp</span> <span class="o">=</span> <span class="n">m</span><span class="o">.</span><span class="n">_NominalRampDownLimit</span><span class="p">[</span><span class="n">g</span><span class="p">]</span> <span class="o">*</span> <span class="n">m</span><span class="o">.</span><span class="n">_TimePeriodLengthHours</span>

        <span class="k">if</span> <span class="n">t</span> <span class="o">==</span> <span class="n">m</span><span class="o">.</span><span class="n">_InitialTime</span><span class="p">:</span>
            <span class="n">param</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">_PowerGeneratedT0</span><span class="p">[</span><span class="n">g</span><span class="p">],</span> <span class="n">m</span><span class="o">.</span><span class="n">_MaximumPowerOutput</span><span class="p">[</span><span class="n">g</span><span class="p">,</span> <span class="n">t</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">param</span> <span class="o">=</span> <span class="n">m</span><span class="o">.</span><span class="n">_MaximumPowerOutput</span><span class="p">[</span><span class="n">g</span><span class="p">,</span> <span class="n">t</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">temp</span> <span class="o">&gt;</span> <span class="n">param</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">param</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">temp</span>

    <span class="n">model</span><span class="o">.</span><span class="n">_ScaledNominalRampDownLimit</span> <span class="o">=</span> <span class="n">tupledict</span><span class="p">(</span>
        <span class="p">{</span>
            <span class="p">(</span><span class="n">g</span><span class="p">,</span> <span class="n">t</span><span class="p">):</span> <span class="n">scale_ramp_down</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">g</span><span class="p">,</span> <span class="n">t</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">g</span> <span class="ow">in</span> <span class="n">model</span><span class="o">.</span><span class="n">_ThermalGenerators</span>
            <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">model</span><span class="o">.</span><span class="n">_TimePeriods</span>
        <span class="p">}</span>
    <span class="p">)</span>

    <span class="k">def</span> <span class="nf">scale_startup_limit</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">g</span><span class="p">,</span> <span class="n">t</span><span class="p">):</span>
        <span class="c1"># temp now has the &quot;running room&quot; over Pmin. This will be scaled for the time period length,</span>
        <span class="c1"># most market models do not have this notion, so this is set-up so that the defaults</span>
        <span class="c1"># will be scaled as they would be in most market models</span>
        <span class="n">temp</span> <span class="o">=</span> <span class="n">m</span><span class="o">.</span><span class="n">_StartupRampLimit</span><span class="p">[</span><span class="n">g</span><span class="p">,</span> <span class="n">t</span><span class="p">]</span> <span class="o">-</span> <span class="n">m</span><span class="o">.</span><span class="n">_MinimumPowerOutput</span><span class="p">[</span><span class="n">g</span><span class="p">,</span> <span class="n">t</span><span class="p">]</span>
        <span class="n">temp</span> <span class="o">*=</span> <span class="n">m</span><span class="o">.</span><span class="n">_TimePeriodLengthHours</span>

        <span class="k">if</span> <span class="n">temp</span> <span class="o">&gt;</span> <span class="n">m</span><span class="o">.</span><span class="n">_MaximumPowerOutput</span><span class="p">[</span><span class="n">g</span><span class="p">,</span> <span class="n">t</span><span class="p">]</span> <span class="o">-</span> <span class="n">m</span><span class="o">.</span><span class="n">_MinimumPowerOutput</span><span class="p">[</span><span class="n">g</span><span class="p">,</span> <span class="n">t</span><span class="p">]:</span>
            <span class="k">return</span> <span class="n">m</span><span class="o">.</span><span class="n">_MaximumPowerOutput</span><span class="p">[</span><span class="n">g</span><span class="p">,</span> <span class="n">t</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">temp</span> <span class="o">+</span> <span class="n">m</span><span class="o">.</span><span class="n">_MinimumPowerOutput</span><span class="p">[</span><span class="n">g</span><span class="p">,</span> <span class="n">t</span><span class="p">]</span>

    <span class="n">model</span><span class="o">.</span><span class="n">_ScaledStartupRampLimit</span> <span class="o">=</span> <span class="n">tupledict</span><span class="p">(</span>
        <span class="p">{</span>
            <span class="p">(</span><span class="n">g</span><span class="p">,</span> <span class="n">t</span><span class="p">):</span> <span class="n">scale_startup_limit</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">g</span><span class="p">,</span> <span class="n">t</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">g</span> <span class="ow">in</span> <span class="n">model</span><span class="o">.</span><span class="n">_ThermalGenerators</span>
            <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">model</span><span class="o">.</span><span class="n">_TimePeriods</span>
        <span class="p">}</span>
    <span class="p">)</span>

    <span class="k">def</span> <span class="nf">scale_shutdown_limit</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">g</span><span class="p">,</span> <span class="n">t</span><span class="p">):</span>
        <span class="c1"># temp now has the &quot;running room&quot; over Pmin. This will be scaled for the time period length</span>
        <span class="c1"># most market models do not have this notion, so this is set-up so that the defaults</span>
        <span class="c1"># will be scaled as they would be in most market models</span>
        <span class="n">temp</span> <span class="o">=</span> <span class="n">m</span><span class="o">.</span><span class="n">_ShutdownRampLimit</span><span class="p">[</span><span class="n">g</span><span class="p">,</span> <span class="n">t</span><span class="p">]</span> <span class="o">-</span> <span class="n">m</span><span class="o">.</span><span class="n">_MinimumPowerOutput</span><span class="p">[</span><span class="n">g</span><span class="p">,</span> <span class="n">t</span><span class="p">]</span>
        <span class="n">temp</span> <span class="o">*=</span> <span class="n">m</span><span class="o">.</span><span class="n">_TimePeriodLengthHours</span>

        <span class="k">if</span> <span class="n">temp</span> <span class="o">&gt;</span> <span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">_MaximumPowerOutput</span><span class="p">[</span><span class="n">g</span><span class="p">,</span> <span class="n">t</span><span class="p">]</span> <span class="o">-</span> <span class="n">m</span><span class="o">.</span><span class="n">_MinimumPowerOutput</span><span class="p">[</span><span class="n">g</span><span class="p">,</span> <span class="n">t</span><span class="p">]):</span>
            <span class="k">return</span> <span class="n">m</span><span class="o">.</span><span class="n">_MaximumPowerOutput</span><span class="p">[</span><span class="n">g</span><span class="p">,</span> <span class="n">t</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">temp</span> <span class="o">+</span> <span class="n">m</span><span class="o">.</span><span class="n">_MinimumPowerOutput</span><span class="p">[</span><span class="n">g</span><span class="p">,</span> <span class="n">t</span><span class="p">]</span>

    <span class="n">model</span><span class="o">.</span><span class="n">_ScaledShutdownRampLimit</span> <span class="o">=</span> <span class="n">tupledict</span><span class="p">(</span>
        <span class="p">{</span>
            <span class="p">(</span><span class="n">g</span><span class="p">,</span> <span class="n">t</span><span class="p">):</span> <span class="n">scale_shutdown_limit</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">g</span><span class="p">,</span> <span class="n">t</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">g</span> <span class="ow">in</span> <span class="n">model</span><span class="o">.</span><span class="n">_ThermalGenerators</span>
            <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">model</span><span class="o">.</span><span class="n">_TimePeriods</span>
        <span class="p">}</span>
    <span class="p">)</span>

    <span class="n">ramp_limit_validator</span><span class="p">(</span><span class="n">model</span><span class="p">)</span>

    <span class="c1"># Some additional ramping parameters to</span>
    <span class="c1"># deal with shutdowns at time=1</span>

    <span class="k">def</span> <span class="nf">_init_p_min_t0</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">g</span><span class="p">):</span>
        <span class="k">if</span> <span class="p">(</span>
                <span class="s2">&quot;initial_p_min&quot;</span> <span class="ow">in</span> <span class="n">thermal_gen_attrs</span>
                <span class="ow">and</span> <span class="n">g</span> <span class="ow">in</span> <span class="n">thermal_gen_attrs</span><span class="p">[</span><span class="s2">&quot;initial_p_min&quot;</span><span class="p">]</span>
        <span class="p">):</span>
            <span class="k">return</span> <span class="n">thermal_gen_attrs</span><span class="p">[</span><span class="s2">&quot;initial_p_min&quot;</span><span class="p">][</span><span class="n">g</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">m</span><span class="o">.</span><span class="n">_MinimumPowerOutput</span><span class="p">[</span><span class="n">g</span><span class="p">,</span> <span class="n">m</span><span class="o">.</span><span class="n">_InitialTime</span><span class="p">]</span>

    <span class="n">model</span><span class="o">.</span><span class="n">_MinimumPowerOutputT0</span> <span class="o">=</span> <span class="n">tupledict</span><span class="p">(</span>
        <span class="p">{</span><span class="n">g</span><span class="p">:</span> <span class="n">_init_p_min_t0</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">g</span><span class="p">)</span> <span class="k">for</span> <span class="n">g</span> <span class="ow">in</span> <span class="n">model</span><span class="o">.</span><span class="n">_ThermalGenerators</span><span class="p">}</span>
    <span class="p">)</span>

    <span class="k">def</span> <span class="nf">_init_sd_t0</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">g</span><span class="p">):</span>
        <span class="k">if</span> <span class="p">(</span>
                <span class="s2">&quot;initial_shutdown_capacity&quot;</span> <span class="ow">in</span> <span class="n">thermal_gen_attrs</span>
                <span class="ow">and</span> <span class="n">g</span> <span class="ow">in</span> <span class="n">thermal_gen_attrs</span><span class="p">[</span><span class="s2">&quot;initial_shutdown_capacity&quot;</span><span class="p">]</span>
        <span class="p">):</span>
            <span class="k">return</span> <span class="n">thermal_gen_attrs</span><span class="p">[</span><span class="s2">&quot;initial_shutdown_capacity&quot;</span><span class="p">][</span><span class="n">g</span><span class="p">]</span>

        <span class="k">return</span> <span class="n">m</span><span class="o">.</span><span class="n">_ShutdownRampLimit</span><span class="p">[</span><span class="n">g</span><span class="p">,</span> <span class="n">m</span><span class="o">.</span><span class="n">_InitialTime</span><span class="p">]</span>

    <span class="n">model</span><span class="o">.</span><span class="n">_ShutdownRampLimitT0</span> <span class="o">=</span> <span class="n">tupledict</span><span class="p">(</span>
        <span class="p">{</span><span class="n">g</span><span class="p">:</span> <span class="n">_init_sd_t0</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">g</span><span class="p">)</span> <span class="k">for</span> <span class="n">g</span> <span class="ow">in</span> <span class="n">model</span><span class="o">.</span><span class="n">_ThermalGenerators</span><span class="p">}</span>
    <span class="p">)</span>

    <span class="k">def</span> <span class="nf">scale_shutdown_limit_t0</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">g</span><span class="p">):</span>
        <span class="c1"># temp now has the &quot;running room&quot; over Pmin. This will be scaled for the time period length</span>
        <span class="c1"># most market models do not have this notion, so this is set-up so that the defaults</span>
        <span class="c1"># will be scaled as they would be in most market models</span>
        <span class="n">temp</span> <span class="o">=</span> <span class="n">m</span><span class="o">.</span><span class="n">_ShutdownRampLimitT0</span><span class="p">[</span><span class="n">g</span><span class="p">]</span> <span class="o">-</span> <span class="n">m</span><span class="o">.</span><span class="n">_MinimumPowerOutputT0</span><span class="p">[</span><span class="n">g</span><span class="p">]</span>
        <span class="n">temp</span> <span class="o">*=</span> <span class="n">m</span><span class="o">.</span><span class="n">_TimePeriodLengthHours</span>

        <span class="k">if</span> <span class="n">temp</span> <span class="o">&gt;</span> <span class="n">m</span><span class="o">.</span><span class="n">_PowerGeneratedT0</span><span class="p">[</span><span class="n">g</span><span class="p">]</span> <span class="o">-</span> <span class="n">m</span><span class="o">.</span><span class="n">_MinimumPowerOutputT0</span><span class="p">[</span><span class="n">g</span><span class="p">]:</span>
            <span class="k">return</span> <span class="n">m</span><span class="o">.</span><span class="n">_PowerGeneratedT0</span><span class="p">[</span><span class="n">g</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">temp</span> <span class="o">+</span> <span class="n">m</span><span class="o">.</span><span class="n">_MinimumPowerOutputT0</span><span class="p">[</span><span class="n">g</span><span class="p">]</span>

    <span class="n">model</span><span class="o">.</span><span class="n">_ScaledShutdownRampLimitT0</span> <span class="o">=</span> <span class="n">tupledict</span><span class="p">(</span>
        <span class="p">{</span>
            <span class="n">g</span><span class="p">:</span> <span class="n">scale_shutdown_limit_t0</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">g</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">g</span> <span class="ow">in</span> <span class="n">model</span><span class="o">.</span><span class="n">_ThermalGenerators</span>
        <span class="p">}</span>
    <span class="p">)</span>


    <span class="c1"># Startup cost parameters for each generator.</span>

    <span class="c1"># Startup costs are conceptually expressed as pairs (x, y), where x represents the number of hours that a unit has been off and y represents</span>
    <span class="c1"># the cost associated with starting up the unit after being off for x hours. these are broken into two distinct ordered sets, as follows.</span>

    <span class="k">def</span> <span class="nf">_get_startup_lag</span><span class="p">(</span><span class="n">startup</span><span class="p">,</span> <span class="n">default</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="nb">iter</span><span class="p">(</span><span class="n">startup</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">TypeError</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">[</span><span class="n">default</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">[</span><span class="n">i</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">startup</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">startup_lags_init_rule</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">g</span><span class="p">):</span>
        <span class="n">startup_cost</span> <span class="o">=</span> <span class="n">thermal_gens</span><span class="p">[</span><span class="n">g</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;startup_cost&quot;</span><span class="p">)</span>
        <span class="n">startup_fuel</span> <span class="o">=</span> <span class="n">thermal_gens</span><span class="p">[</span><span class="n">g</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;startup_fuel&quot;</span><span class="p">)</span>

        <span class="c1"># if startup_cost is not None and startup_fuel is not None:</span>
        <span class="c1">#     logger.warning(&quot;WARNING: found startup_fuel for generator }, &quot;</span>
        <span class="c1">#                    &quot;ignoring startup_cost&quot;.format(g))</span>

        <span class="k">if</span> <span class="n">startup_fuel</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">startup_cost</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">[</span><span class="n">model</span><span class="o">.</span><span class="n">__MinimumDownTime</span><span class="p">[</span><span class="n">g</span><span class="p">]]</span>

        <span class="k">elif</span> <span class="n">startup_cost</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">_get_startup_lag</span><span class="p">(</span><span class="n">startup_fuel</span><span class="p">,</span> <span class="n">model</span><span class="o">.</span><span class="n">__MinimumDownTime</span><span class="p">[</span><span class="n">g</span><span class="p">])</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">_get_startup_lag</span><span class="p">(</span><span class="n">startup_cost</span><span class="p">,</span> <span class="n">m</span><span class="o">.</span><span class="n">_MinimumDownTime</span><span class="p">[</span><span class="n">g</span><span class="p">])</span>

    <span class="c1"># Units are hours / time periods.</span>
    <span class="n">model</span><span class="o">.</span><span class="n">_StartupLags</span> <span class="o">=</span> <span class="p">{</span>
        <span class="n">g</span><span class="p">:</span> <span class="n">startup_lags_init_rule</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">g</span><span class="p">)</span> <span class="k">for</span> <span class="n">g</span> <span class="ow">in</span> <span class="n">model</span><span class="o">.</span><span class="n">_ThermalGenerators</span>
    <span class="p">}</span>

    <span class="k">def</span> <span class="nf">_get_startup_cost</span><span class="p">(</span><span class="n">startup</span><span class="p">,</span> <span class="n">fixed_adder</span><span class="p">,</span> <span class="n">multiplier</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="nb">iter</span><span class="p">(</span><span class="n">startup</span><span class="p">)</span>

        <span class="k">except</span> <span class="ne">TypeError</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">[</span><span class="n">fixed_adder</span> <span class="o">+</span> <span class="n">multiplier</span> <span class="o">*</span> <span class="n">startup</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">[</span><span class="n">fixed_adder</span> <span class="o">+</span> <span class="n">multiplier</span> <span class="o">*</span> <span class="n">i</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">startup</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">startup_costs_init_rule</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">g</span><span class="p">):</span>
        <span class="n">startup_cost</span> <span class="o">=</span> <span class="n">thermal_gens</span><span class="p">[</span><span class="n">g</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;startup_cost&quot;</span><span class="p">)</span>
        <span class="n">startup_fuel</span> <span class="o">=</span> <span class="n">thermal_gens</span><span class="p">[</span><span class="n">g</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;startup_fuel&quot;</span><span class="p">)</span>
        <span class="n">fixed_startup_cost</span> <span class="o">=</span> <span class="n">thermal_gens</span><span class="p">[</span><span class="n">g</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;non_fuel_startup_cost&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">fixed_startup_cost</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">fixed_startup_cost</span> <span class="o">=</span> <span class="mf">0.0</span>

        <span class="k">if</span> <span class="n">startup_fuel</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">startup_cost</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">[</span><span class="n">fixed_startup_cost</span><span class="p">]</span>

        <span class="k">elif</span> <span class="n">startup_cost</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">fuel_cost</span> <span class="o">=</span> <span class="n">thermal_gens</span><span class="p">[</span><span class="n">g</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;fuel_cost&quot;</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">fuel_cost</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">ModelError</span><span class="p">(</span>
                    <span class="s2">&quot;No fuel cost for generator }, but data is &quot;</span>
                    <span class="s2">&quot;provided for fuel tracking&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">g</span><span class="p">)</span>
                <span class="p">)</span>

            <span class="k">return</span> <span class="n">_get_startup_cost</span><span class="p">(</span>
                <span class="n">startup_fuel</span><span class="p">,</span> <span class="n">fixed_startup_cost</span><span class="p">,</span> <span class="n">fuel_cost</span>
            <span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">_get_startup_cost</span><span class="p">(</span><span class="n">startup_cost</span><span class="p">,</span> <span class="n">fixed_startup_cost</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">)</span>

    <span class="c1"># Units are $.</span>
    <span class="n">model</span><span class="o">.</span><span class="n">_StartupCosts</span> <span class="o">=</span> <span class="p">{</span>
        <span class="n">g</span><span class="p">:</span> <span class="n">startup_costs_init_rule</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">g</span><span class="p">)</span> <span class="k">for</span> <span class="n">g</span> <span class="ow">in</span> <span class="n">model</span><span class="o">.</span><span class="n">_ThermalGenerators</span>
    <span class="p">}</span>

    <span class="c1"># Startup lags must be monotonically increasing...</span>
    <span class="k">def</span> <span class="nf">validate_startup_lags_rule</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">g</span><span class="p">):</span>
        <span class="n">startup_lags</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">_StartupLags</span><span class="p">[</span><span class="n">g</span><span class="p">])</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">startup_lags</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">ModelError</span><span class="p">(</span>
                <span class="s2">&quot;DATA ERROR: The number of startup lags for &quot;</span>
                <span class="s2">&quot;thermal generator `}` must be &gt;= 1!&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">g</span><span class="p">)</span>
            <span class="p">)</span>

        <span class="k">if</span> <span class="n">startup_lags</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="n">m</span><span class="o">.</span><span class="n">_MinimumDownTime</span><span class="p">[</span><span class="n">g</span><span class="p">]:</span>
            <span class="k">raise</span> <span class="n">ModelError</span><span class="p">(</span>
                <span class="s2">&quot;DATA ERROR: The first startup lag for thermal generator `}` &quot;</span>
                <span class="s2">&quot;must be equal the minimum down time }!&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="n">g</span><span class="p">,</span> <span class="n">m</span><span class="o">.</span><span class="n">_MinimumDownTime</span><span class="p">[</span><span class="n">g</span><span class="p">]</span>
                <span class="p">)</span>
            <span class="p">)</span>

        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">startup_lags</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">startup_lags</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">startup_lags</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]:</span>
                <span class="k">raise</span> <span class="n">ModelError</span><span class="p">(</span>
                    <span class="s2">&quot;DATA ERROR: Startup lags for thermal generator `}` must &quot;</span>
                    <span class="s2">&quot;be monotonically increasing!&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">g</span><span class="p">)</span>
                <span class="p">)</span>

    <span class="p">[</span><span class="n">validate_startup_lags_rule</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">g</span><span class="p">)</span> <span class="k">for</span> <span class="n">g</span> <span class="ow">in</span> <span class="n">model</span><span class="o">.</span><span class="n">_ThermalGenerators</span><span class="p">]</span>

    <span class="c1"># While startup costs must be monotonically non-decreasing!</span>
    <span class="k">def</span> <span class="nf">validate_startup_costs_rule</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">g</span><span class="p">):</span>
        <span class="n">startup_costs</span> <span class="o">=</span> <span class="n">m</span><span class="o">.</span><span class="n">_StartupCosts</span><span class="p">[</span><span class="n">g</span><span class="p">]</span>

        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">startup_costs</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">startup_costs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">startup_costs</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]:</span>
                <span class="k">raise</span> <span class="n">ModelError</span><span class="p">(</span>
                    <span class="s2">&quot;DATA ERROR: Startup costs for thermal generator `}` must &quot;</span>
                    <span class="s2">&quot;be monotonically non-decreasing!&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">g</span><span class="p">)</span>
                <span class="p">)</span>

    <span class="p">[</span><span class="n">validate_startup_costs_rule</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">g</span><span class="p">)</span> <span class="k">for</span> <span class="n">g</span> <span class="ow">in</span> <span class="n">model</span><span class="o">.</span><span class="n">_ThermalGenerators</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">validate_startup_lag_cost_cardinalities</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">g</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">_StartupLags</span><span class="p">[</span><span class="n">g</span><span class="p">])</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">_StartupCosts</span><span class="p">[</span><span class="n">g</span><span class="p">]):</span>
            <span class="k">raise</span> <span class="n">ModelError</span><span class="p">(</span>
                <span class="s2">&quot;DATA ERROR: The number of startup lag entries (}) for &quot;</span>
                <span class="s2">&quot;thermal generator `}` must equal the number of startup cost &quot;</span>
                <span class="s2">&quot;entries (})&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="nb">len</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">_StartupLags</span><span class="p">[</span><span class="n">g</span><span class="p">]),</span> <span class="n">g</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">_StartupCosts</span><span class="p">[</span><span class="n">g</span><span class="p">])</span>
                <span class="p">)</span>
            <span class="p">)</span>

    <span class="p">[</span>
        <span class="n">validate_startup_lag_cost_cardinalities</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">g</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">g</span> <span class="ow">in</span> <span class="n">model</span><span class="o">.</span><span class="n">_ThermalGenerators</span>
    <span class="p">]</span>

    <span class="c1"># For purposes of defining constraints, it is useful to have a set to index the various startup costs parameters.</span>

    <span class="k">def</span> <span class="nf">startup_cost_indices_init_rule</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">g</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">_StartupLags</span><span class="p">[</span><span class="n">g</span><span class="p">]))</span>

    <span class="n">model</span><span class="o">.</span><span class="n">_StartupCostIndices</span> <span class="o">=</span> <span class="p">{</span>
        <span class="n">g</span><span class="p">:</span> <span class="n">startup_cost_indices_init_rule</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">g</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">g</span> <span class="ow">in</span> <span class="n">model</span><span class="o">.</span><span class="n">_ThermalGenerators</span>
    <span class="p">}</span>

    <span class="c1"># scale the startup lags</span>
    <span class="c1"># Again, assert that this must be at least one in the time units of the model</span>
    <span class="k">def</span> <span class="nf">scaled_startup_lags_rule</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">g</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">[</span>
            <span class="nb">max</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="n">this_lag</span> <span class="o">/</span> <span class="n">m</span><span class="o">.</span><span class="n">_TimePeriodLengthHours</span><span class="p">)),</span> <span class="mi">1</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">this_lag</span> <span class="ow">in</span> <span class="n">m</span><span class="o">.</span><span class="n">_StartupLags</span><span class="p">[</span><span class="n">g</span><span class="p">]</span>
        <span class="p">]</span>

    <span class="n">model</span><span class="o">.</span><span class="n">_ScaledStartupLags</span> <span class="o">=</span> <span class="p">{</span>
        <span class="n">g</span><span class="p">:</span> <span class="n">scaled_startup_lags_rule</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">g</span><span class="p">)</span> <span class="k">for</span> <span class="n">g</span> <span class="ow">in</span> <span class="n">model</span><span class="o">.</span><span class="n">_ThermalGenerators</span>
    <span class="p">}</span>

    <span class="c1"># Shutdown cost for each generator. in the literature, these are often set to 0.</span>

    <span class="c1"># units are $.</span>
    <span class="n">model</span><span class="o">.</span><span class="n">_ShutdownFixedCost</span> <span class="o">=</span> <span class="n">tupledict</span><span class="p">(</span>
        <span class="n">thermal_gen_attrs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
            <span class="s2">&quot;shutdown_cost&quot;</span><span class="p">,</span> <span class="p">{</span><span class="n">g</span><span class="p">:</span> <span class="mi">0</span> <span class="k">for</span> <span class="n">g</span> <span class="ow">in</span> <span class="n">model</span><span class="o">.</span><span class="n">_ThermalGenerators</span><span class="p">}</span>
        <span class="p">)</span>
    <span class="p">)</span>

    <span class="c1"># FUEL-SUPPLY Sets</span>
    <span class="k">def</span> <span class="nf">fuel_supply_gens_init</span><span class="p">(</span><span class="n">m</span><span class="p">):</span>
        <span class="k">if</span> <span class="s2">&quot;fuel_supply&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">thermal_gen_attrs</span><span class="p">:</span>
            <span class="n">thermal_gen_attrs</span><span class="p">[</span><span class="s2">&quot;fuel_supply&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">tupledict</span><span class="p">()</span>

        <span class="k">if</span> <span class="s2">&quot;aux_fuel_supply&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">thermal_gen_attrs</span><span class="p">:</span>
            <span class="n">thermal_gen_attrs</span><span class="p">[</span><span class="s2">&quot;aux_fuel_supply&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">tupledict</span><span class="p">()</span>

        <span class="n">fuel_supply</span> <span class="o">=</span> <span class="n">thermal_gen_attrs</span><span class="p">[</span><span class="s2">&quot;fuel_supply&quot;</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">g</span> <span class="ow">in</span> <span class="n">fuel_supply</span><span class="p">:</span>
            <span class="k">yield</span> <span class="n">g</span>

        <span class="k">for</span> <span class="n">g</span> <span class="ow">in</span> <span class="n">thermal_gen_attrs</span><span class="p">[</span><span class="s2">&quot;aux_fuel_supply&quot;</span><span class="p">]:</span>
            <span class="k">if</span> <span class="n">g</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">fuel_supply</span><span class="p">:</span>
                <span class="k">yield</span> <span class="n">g</span>

    <span class="k">def</span> <span class="nf">gen_cost_fuel_validator</span><span class="p">(</span><span class="n">g</span><span class="p">):</span>
        <span class="c1"># validators may get called once</span>
        <span class="c1"># with key None for empty sets</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">g</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">True</span>

        <span class="k">if</span> <span class="s2">&quot;p_fuel&quot;</span> <span class="ow">in</span> <span class="n">thermal_gen_attrs</span> <span class="ow">and</span> <span class="n">g</span> <span class="ow">in</span> <span class="n">thermal_gen_attrs</span><span class="p">[</span><span class="s2">&quot;p_fuel&quot;</span><span class="p">]:</span>
            <span class="k">pass</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">ModelError</span><span class="p">(</span>
                <span class="s2">&quot;All fuel-constrained generators must have the &quot;</span>
                <span class="s2">&quot;&lt;p_fuel&gt; attribute which tracks their fuel &quot;</span>
                <span class="s2">&quot;consumption, could not find such an attribute &quot;</span>
                <span class="s2">&quot;for generator `</span><span class="si">{}</span><span class="s2">`!&#39;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">g</span><span class="p">)</span>
            <span class="p">)</span>

        <span class="k">return</span> <span class="kc">True</span>

    <span class="n">model</span><span class="o">.</span><span class="n">_FuelSupplyGenerators</span> <span class="o">=</span> <span class="n">OrderedSet</span><span class="p">(</span><span class="n">fuel_supply_gens_init</span><span class="p">(</span><span class="n">model</span><span class="p">))</span>
    <span class="n">gen_cost_fuel_validator</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">_FuelSupplyGenerators</span><span class="p">)</span>

    <span class="c1"># DUAL-FUEL Sets</span>

    <span class="k">def</span> <span class="nf">dual_fuel_init</span><span class="p">(</span><span class="n">m</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">gen</span><span class="p">,</span> <span class="n">g_data</span> <span class="ow">in</span> <span class="n">thermal_gens</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="s2">&quot;aux_fuel_capable&quot;</span> <span class="ow">in</span> <span class="n">g_data</span> <span class="ow">and</span> <span class="n">g_data</span><span class="p">[</span><span class="s2">&quot;aux_fuel_capable&quot;</span><span class="p">]:</span>
                <span class="k">yield</span> <span class="n">gen</span>

    <span class="n">model</span><span class="o">.</span><span class="n">_DualFuelGenerators</span> <span class="o">=</span> <span class="n">OrderedSet</span><span class="p">(</span><span class="n">dual_fuel_init</span><span class="p">(</span><span class="n">model</span><span class="p">))</span>

    <span class="c1"># This set is for modeling elements that are exhanged</span>
    <span class="c1"># in whole for the dual-fuel model</span>
    <span class="n">model</span><span class="o">.</span><span class="n">_SingleFuelGenerators</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">model</span><span class="o">.</span><span class="n">_ThermalGenerators</span> <span class="o">-</span> <span class="n">model</span><span class="o">.</span><span class="n">_DualFuelGenerators</span>
    <span class="p">)</span>

    <span class="c1"># BEGIN PRODUCTION COST</span>
    <span class="c1"># NOTE: For better or worse, we handle scaling this to the time period length in the objective function.</span>
    <span class="c1">#       In particular, this is done in objective.py.</span>

    <span class="k">def</span> <span class="nf">_check_curve</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">g</span><span class="p">,</span> <span class="n">curve</span><span class="p">,</span> <span class="n">curve_type</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">t</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">_TimePeriods</span><span class="p">):</span>
            <span class="c1"># first, get a cost_curve out of time series</span>
            <span class="k">if</span> <span class="n">curve</span><span class="p">[</span><span class="s2">&quot;data_type&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;time_series&quot;</span><span class="p">:</span>
                <span class="n">curve_t</span> <span class="o">=</span> <span class="n">curve</span><span class="p">[</span><span class="s2">&quot;values&quot;</span><span class="p">][</span><span class="n">i</span><span class="p">]</span>
                <span class="n">_t</span> <span class="o">=</span> <span class="n">t</span>

            <span class="k">else</span><span class="p">:</span>
                <span class="n">curve_t</span> <span class="o">=</span> <span class="n">curve</span>
                <span class="n">_t</span> <span class="o">=</span> <span class="kc">None</span>

            <span class="n">tx_utils</span><span class="o">.</span><span class="n">validate_and_clean_cost_curve</span><span class="p">(</span>
                <span class="n">curve_t</span><span class="p">,</span>
                <span class="n">curve_type</span><span class="o">=</span><span class="n">curve_type</span><span class="p">,</span>
                <span class="n">p_min</span><span class="o">=</span><span class="n">m</span><span class="o">.</span><span class="n">_MinimumPowerOutput</span><span class="p">[</span><span class="n">g</span><span class="p">,</span> <span class="n">t</span><span class="p">],</span>
                <span class="n">p_max</span><span class="o">=</span><span class="n">m</span><span class="o">.</span><span class="n">_MaximumPowerOutput</span><span class="p">[</span><span class="n">g</span><span class="p">,</span> <span class="n">t</span><span class="p">],</span>
                <span class="n">gen_name</span><span class="o">=</span><span class="n">g</span><span class="p">,</span>
                <span class="n">t</span><span class="o">=</span><span class="n">_t</span><span class="p">,</span>
            <span class="p">)</span>

            <span class="c1"># if no curve_type+&#39;_type&#39; is specified, we assume piecewise</span>
            <span class="c1"># (for backwards compatibility with no &#39;fuel_curve_type&#39;)</span>
            <span class="k">if</span> <span class="p">(</span>
                    <span class="n">curve_type</span> <span class="o">+</span> <span class="s2">&quot;_type&quot;</span> <span class="ow">in</span> <span class="n">curve</span>
                    <span class="ow">and</span> <span class="n">curve_t</span><span class="p">[</span><span class="n">curve_type</span> <span class="o">+</span> <span class="s2">&quot;_type&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;polynomial&quot;</span>
            <span class="p">):</span>
                <span class="c1"># if not _check_curve.warn_piecewise_approx:</span>
                <span class="c1">#     logger.warning(&quot;WARNING: Polynomial cost curves will be &quot;</span>
                <span class="c1">#                    &quot;approximated using piecewise segments&quot;)</span>
                <span class="n">_check_curve</span><span class="o">.</span><span class="n">warn_piecewise_approx</span> <span class="o">=</span> <span class="kc">True</span>

            <span class="k">if</span> <span class="n">curve</span><span class="p">[</span><span class="s2">&quot;data_type&quot;</span><span class="p">]</span> <span class="o">!=</span> <span class="s2">&quot;time_series&quot;</span><span class="p">:</span>
                <span class="k">break</span>

    <span class="c1"># Set &quot;static&quot; variable for this function</span>
    <span class="n">_check_curve</span><span class="o">.</span><span class="n">warn_piecewise_approx</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="k">def</span> <span class="nf">validate_cost_rule</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">g</span><span class="p">):</span>
        <span class="n">gen_dict</span> <span class="o">=</span> <span class="n">thermal_gens</span><span class="p">[</span><span class="n">g</span><span class="p">]</span>
        <span class="n">cost</span> <span class="o">=</span> <span class="n">gen_dict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;p_cost&quot;</span><span class="p">)</span>
        <span class="n">fuel</span> <span class="o">=</span> <span class="n">gen_dict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;p_fuel&quot;</span><span class="p">)</span>
        <span class="n">fuel_cost</span> <span class="o">=</span> <span class="n">gen_dict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;fuel_cost&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">cost</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">fuel</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;WARNING: Generator </span><span class="si">{}</span><span class="s2"> has no cost information &quot;</span>
                           <span class="s2">&quot;associated with it&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">g</span><span class="p">))</span>
            <span class="k">return</span> <span class="kc">True</span>

        <span class="k">if</span> <span class="n">cost</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">fuel</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;WARNING: ignoring provided p_cost and using fuel &quot;</span>
                           <span class="s2">&quot;cost data from p_fuel for generator </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">g</span><span class="p">))</span>

        <span class="c1"># look at p_cost through time</span>

        <span class="k">if</span> <span class="n">fuel</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">_check_curve</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">g</span><span class="p">,</span> <span class="n">cost</span><span class="p">,</span> <span class="s2">&quot;cost_curve&quot;</span><span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">fuel_cost</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">ModelError</span><span class="p">(</span>
                    <span class="s2">&quot;Found fuel_curve but not fuel_cost &quot;</span>
                    <span class="s2">&quot;for generator </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">g</span><span class="p">)</span>
                <span class="p">)</span>

            <span class="n">_check_curve</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">g</span><span class="p">,</span> <span class="n">fuel</span><span class="p">,</span> <span class="s2">&quot;fuel_curve&quot;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">t</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">_TimePeriods</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">fuel_cost</span> <span class="ow">is</span> <span class="nb">dict</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">fuel_cost</span><span class="p">[</span><span class="s2">&quot;data_type&quot;</span><span class="p">]</span> <span class="o">!=</span> <span class="s2">&quot;time_series&quot;</span><span class="p">:</span>
                        <span class="k">raise</span> <span class="n">ModelError</span><span class="p">(</span>
                            <span class="s2">&quot;fuel_cost must be either numeric &quot;</span>
                            <span class="s2">&quot;or time_series&quot;</span>
                        <span class="p">)</span>

                    <span class="n">fuel_cost_t</span> <span class="o">=</span> <span class="n">fuel_cost</span><span class="p">[</span><span class="s2">&quot;values&quot;</span><span class="p">][</span><span class="n">i</span><span class="p">]</span>

                <span class="k">else</span><span class="p">:</span>
                    <span class="n">fuel_cost_t</span> <span class="o">=</span> <span class="n">fuel_cost</span>

                <span class="k">if</span> <span class="n">fuel_cost_t</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="n">ModelError</span><span class="p">(</span>
                        <span class="s2">&quot;fuel_cost must be non-negative, found negative &quot;</span>
                        <span class="s2">&quot;fuel_cost for generator `</span><span class="si">{}</span><span class="s2">`!&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">g</span><span class="p">)</span>
                    <span class="p">)</span>

                <span class="k">if</span> <span class="n">fuel_cost_t</span> <span class="o">==</span> <span class="n">fuel_cost</span><span class="p">:</span>
                    <span class="k">break</span>

        <span class="k">return</span> <span class="kc">True</span>

    <span class="n">model</span><span class="o">.</span><span class="n">_ValidateGeneratorCost</span> <span class="o">=</span> <span class="n">tupledict</span><span class="p">(</span>
        <span class="p">{</span><span class="n">g</span><span class="p">:</span> <span class="n">validate_cost_rule</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">g</span><span class="p">)</span> <span class="k">for</span> <span class="n">g</span> <span class="ow">in</span> <span class="n">model</span><span class="o">.</span><span class="n">_ThermalGenerators</span><span class="p">}</span>
    <span class="p">)</span>

    <span class="c1"># Number of pieces in the linearization of each generator&#39;s quadratic cost production curve.</span>

    <span class="n">model</span><span class="o">.</span><span class="n">_NumGeneratorCostCurvePieces</span> <span class="o">=</span> <span class="mi">2</span>

    <span class="c1"># Points for piecewise linearization of power generation cost curves.</span>
    <span class="c1"># BK -- changed to reflect that the generator&#39;s power output variable is always above minimum in the ME model</span>
    <span class="c1">#       this simplifies things quite a bit..</span>

    <span class="c1"># maps a (generator, time-index) pair to a list of points defining the piecewise cost linearization breakpoints.</span>
    <span class="c1"># the time index is redundant, but required - in the current implementation of the Piecewise construct, the</span>
    <span class="c1"># breakpoints must be indexed the same as the Piecewise construct itself.</span>

    <span class="c1"># the points are expected to be on the interval [0, maxpower-minpower], and must contain both endpoints.</span>
    <span class="c1"># power generated can always be 0, and piecewise expects the entire variable domain to be represented.</span>
    <span class="n">model</span><span class="o">.</span><span class="n">_PowerGenerationPiecewisePoints</span> <span class="o">=</span> <span class="n">tupledict</span><span class="p">()</span>

    <span class="c1"># NOTE: the values are relative to the minimum production cost, i.e., the values represent</span>
    <span class="c1"># incremental costs relative to the minimum production cost.</span>
    <span class="n">model</span><span class="o">.</span><span class="n">_PowerGenerationPiecewiseCostValues</span> <span class="o">=</span> <span class="n">tupledict</span><span class="p">()</span>

    <span class="c1"># NOTE; these values are relative to the minimum fuel conumption</span>
    <span class="n">model</span><span class="o">.</span><span class="n">_PowerGenerationPiecewiseFuelValues</span> <span class="o">=</span> <span class="n">tupledict</span><span class="p">()</span>

    <span class="n">_minimum_production_cost</span> <span class="o">=</span> <span class="n">tupledict</span><span class="p">()</span>
    <span class="n">_minimum_fuel_consumption</span> <span class="o">=</span> <span class="n">tupledict</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_eliminate_piecewise_duplicates</span><span class="p">(</span><span class="n">input_func</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">input_func</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">input_func</span>

        <span class="n">new</span> <span class="o">=</span> <span class="p">[</span><span class="n">input_func</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>
        <span class="k">for</span> <span class="p">(</span><span class="n">o1</span><span class="p">,</span> <span class="n">c1</span><span class="p">),</span> <span class="p">(</span><span class="n">o2</span><span class="p">,</span> <span class="n">c2</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">input_func</span><span class="p">,</span> <span class="n">input_func</span><span class="p">[</span><span class="mi">1</span><span class="p">:]):</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">math</span><span class="o">.</span><span class="n">isclose</span><span class="p">(</span><span class="n">o1</span><span class="p">,</span> <span class="n">o2</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">math</span><span class="o">.</span><span class="n">isclose</span><span class="p">(</span><span class="n">c1</span><span class="p">,</span> <span class="n">c2</span><span class="p">):</span>
                <span class="n">new</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">o2</span><span class="p">,</span> <span class="n">c2</span><span class="p">))</span>

        <span class="k">return</span> <span class="n">new</span>

    <span class="k">def</span> <span class="nf">_much_less_than</span><span class="p">(</span><span class="n">v1</span><span class="p">,</span> <span class="n">v2</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">v1</span> <span class="o">&lt;</span> <span class="n">v2</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">math</span><span class="o">.</span><span class="n">isclose</span><span class="p">(</span><span class="n">v1</span><span class="p">,</span> <span class="n">v2</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_piecewise_adjustment_helper</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">p_min</span><span class="p">,</span> <span class="n">p_max</span><span class="p">,</span> <span class="n">input_func</span><span class="p">):</span>
        <span class="n">minimum_val</span> <span class="o">=</span> <span class="mf">0.0</span>
        <span class="n">new_points</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">new_vals</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="n">input_func</span> <span class="o">=</span> <span class="n">_eliminate_piecewise_duplicates</span><span class="p">(</span><span class="n">input_func</span><span class="p">)</span>
        <span class="n">set_p_min</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="c1"># NOTE: this implicitly inserts a (0.,0.)</span>
        <span class="c1">#       into every cost array</span>
        <span class="n">prior_output</span><span class="p">,</span> <span class="n">prior_cost</span> <span class="o">=</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span>

        <span class="k">for</span> <span class="n">output</span><span class="p">,</span> <span class="n">cost</span> <span class="ow">in</span> <span class="n">input_func</span><span class="p">:</span>
            <span class="c1"># catch this case</span>
            <span class="k">if</span> <span class="n">math</span><span class="o">.</span><span class="n">isclose</span><span class="p">(</span><span class="n">output</span><span class="p">,</span> <span class="n">p_min</span><span class="p">)</span> <span class="ow">and</span> <span class="n">math</span><span class="o">.</span><span class="n">isclose</span><span class="p">(</span><span class="n">output</span><span class="p">,</span> <span class="n">p_max</span><span class="p">):</span>
                <span class="n">new_points</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mf">0.0</span><span class="p">)</span>
                <span class="n">new_vals</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mf">0.0</span><span class="p">)</span>
                <span class="n">minimum_val</span> <span class="o">=</span> <span class="n">cost</span>
                <span class="k">break</span>

            <span class="c1"># output &lt; p_min</span>
            <span class="k">elif</span> <span class="n">_much_less_than</span><span class="p">(</span><span class="n">output</span><span class="p">,</span> <span class="n">p_min</span><span class="p">):</span>
                <span class="k">pass</span>

            <span class="c1"># p_min == output</span>
            <span class="k">elif</span> <span class="n">math</span><span class="o">.</span><span class="n">isclose</span><span class="p">(</span><span class="n">output</span><span class="p">,</span> <span class="n">p_min</span><span class="p">):</span>
                <span class="k">assert</span> <span class="n">set_p_min</span> <span class="ow">is</span> <span class="kc">False</span>
                <span class="n">new_points</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mf">0.0</span><span class="p">)</span>
                <span class="n">new_vals</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mf">0.0</span><span class="p">)</span>
                <span class="n">minimum_val</span> <span class="o">=</span> <span class="n">cost</span>
                <span class="n">set_p_min</span> <span class="o">=</span> <span class="kc">True</span>

            <span class="c1"># p_min &lt; output</span>
            <span class="k">elif</span> <span class="n">_much_less_than</span><span class="p">(</span><span class="n">p_min</span><span class="p">,</span> <span class="n">output</span><span class="p">)</span> <span class="ow">and</span> <span class="n">_much_less_than</span><span class="p">(</span>
                    <span class="n">output</span><span class="p">,</span> <span class="n">p_max</span>
            <span class="p">):</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">set_p_min</span><span class="p">:</span>
                    <span class="n">new_points</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mf">0.0</span><span class="p">)</span>
                    <span class="n">new_vals</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mf">0.0</span><span class="p">)</span>

                    <span class="n">price</span> <span class="o">=</span> <span class="p">(</span><span class="n">cost</span> <span class="o">-</span> <span class="n">prior_cost</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">output</span> <span class="o">-</span> <span class="n">prior_output</span><span class="p">)</span>
                    <span class="n">minimum_val</span> <span class="o">=</span> <span class="p">(</span><span class="n">p_min</span> <span class="o">-</span> <span class="n">prior_output</span><span class="p">)</span> <span class="o">*</span> <span class="n">price</span> <span class="o">+</span> <span class="n">prior_cost</span>

                    <span class="n">new_points</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">output</span> <span class="o">-</span> <span class="n">p_min</span><span class="p">)</span>
                    <span class="n">new_vals</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">output</span> <span class="o">-</span> <span class="n">p_min</span><span class="p">)</span> <span class="o">*</span> <span class="n">price</span><span class="p">)</span>
                    <span class="n">set_p_min</span> <span class="o">=</span> <span class="kc">True</span>

                <span class="k">else</span><span class="p">:</span>
                    <span class="n">new_points</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">output</span> <span class="o">-</span> <span class="n">p_min</span><span class="p">)</span>
                    <span class="n">new_vals</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cost</span> <span class="o">-</span> <span class="n">minimum_val</span><span class="p">)</span>

            <span class="k">elif</span> <span class="n">math</span><span class="o">.</span><span class="n">isclose</span><span class="p">(</span><span class="n">output</span><span class="p">,</span> <span class="n">p_max</span><span class="p">)</span> <span class="ow">or</span> <span class="n">_much_less_than</span><span class="p">(</span><span class="n">p_max</span><span class="p">,</span> <span class="n">output</span><span class="p">):</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">set_p_min</span><span class="p">:</span>
                    <span class="n">new_points</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mf">0.0</span><span class="p">)</span>
                    <span class="n">new_vals</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mf">0.0</span><span class="p">)</span>

                    <span class="n">price</span> <span class="o">=</span> <span class="p">(</span><span class="n">cost</span> <span class="o">-</span> <span class="n">prior_cost</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">output</span> <span class="o">-</span> <span class="n">prior_output</span><span class="p">)</span>
                    <span class="n">minimum_val</span> <span class="o">=</span> <span class="p">(</span><span class="n">p_min</span> <span class="o">-</span> <span class="n">prior_output</span><span class="p">)</span> <span class="o">*</span> <span class="n">price</span> <span class="o">+</span> <span class="n">prior_cost</span>
                    <span class="n">new_points</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">p_max</span> <span class="o">-</span> <span class="n">p_min</span><span class="p">)</span>

                    <span class="k">if</span> <span class="n">math</span><span class="o">.</span><span class="n">isclose</span><span class="p">(</span><span class="n">output</span><span class="p">,</span> <span class="n">p_max</span><span class="p">):</span>
                        <span class="n">new_vals</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cost</span> <span class="o">-</span> <span class="n">minimum_val</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">new_vals</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">p_max</span> <span class="o">-</span> <span class="n">p_min</span><span class="p">)</span> <span class="o">*</span> <span class="n">price</span><span class="p">)</span>

                    <span class="n">set_p_min</span> <span class="o">=</span> <span class="kc">True</span>

                <span class="k">else</span><span class="p">:</span>
                    <span class="n">new_points</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">p_max</span> <span class="o">-</span> <span class="n">p_min</span><span class="p">)</span>

                    <span class="k">if</span> <span class="n">math</span><span class="o">.</span><span class="n">isclose</span><span class="p">(</span><span class="n">output</span><span class="p">,</span> <span class="n">p_max</span><span class="p">):</span>
                        <span class="n">new_vals</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cost</span> <span class="o">-</span> <span class="n">minimum_val</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">price</span> <span class="o">=</span> <span class="p">(</span><span class="n">cost</span> <span class="o">-</span> <span class="n">prior_cost</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">output</span> <span class="o">-</span> <span class="n">prior_output</span><span class="p">)</span>
                        <span class="n">new_vals</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                            <span class="p">(</span><span class="n">p_max</span> <span class="o">-</span> <span class="n">prior_output</span><span class="p">)</span> <span class="o">*</span> <span class="n">price</span>
                            <span class="o">+</span> <span class="n">prior_cost</span>
                            <span class="o">-</span> <span class="n">minimum_val</span>
                        <span class="p">)</span>

                <span class="k">break</span>

            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">ModelError</span><span class="p">(</span>
                    <span class="s2">&quot;Unexpected case in _piecewise_adjustment_helper, &quot;</span>
                    <span class="s2">&quot;p_min=</span><span class="si">{}</span><span class="s2">, p_max=</span><span class="si">{}</span><span class="s2">, output=</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                        <span class="n">p_min</span><span class="p">,</span> <span class="n">p_max</span><span class="p">,</span> <span class="n">output</span>
                    <span class="p">)</span>
                <span class="p">)</span>

            <span class="n">prior_output</span><span class="p">,</span> <span class="n">prior_cost</span> <span class="o">=</span> <span class="n">output</span><span class="p">,</span> <span class="n">cost</span>

        <span class="k">return</span> <span class="n">new_points</span><span class="p">,</span> <span class="n">new_vals</span><span class="p">,</span> <span class="n">minimum_val</span>

    <span class="k">def</span> <span class="nf">_polynomial_to_piecewise_helper</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">p_min</span><span class="p">,</span> <span class="n">p_max</span><span class="p">,</span> <span class="n">input_func</span><span class="p">):</span>
        <span class="n">segment_max</span> <span class="o">=</span> <span class="n">m</span><span class="o">.</span><span class="n">_NumGeneratorCostCurvePieces</span>

        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="p">{</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">}:</span>
            <span class="k">if</span> <span class="n">key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">input_func</span><span class="p">:</span>
                <span class="n">input_func</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0</span>

        <span class="n">poly_func</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="p">(</span>
                <span class="n">input_func</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">input_func</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="n">x</span> <span class="o">+</span> <span class="n">input_func</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">*</span> <span class="n">x</span> <span class="o">*</span> <span class="n">x</span>
        <span class="p">)</span>

        <span class="k">if</span> <span class="n">p_min</span> <span class="o">&gt;=</span> <span class="n">p_max</span><span class="p">:</span>
            <span class="n">minimum_val</span> <span class="o">=</span> <span class="n">poly_func</span><span class="p">(</span><span class="n">p_min</span><span class="p">)</span>
            <span class="n">new_points</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.0</span><span class="p">]</span>
            <span class="n">new_vals</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.0</span><span class="p">]</span>

            <span class="k">return</span> <span class="n">new_points</span><span class="p">,</span> <span class="n">new_vals</span><span class="p">,</span> <span class="n">minimum_val</span>

        <span class="k">elif</span> <span class="n">input_func</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">==</span> <span class="mf">0.0</span><span class="p">:</span>  <span class="c1"># not actually quadratic</span>
            <span class="n">minimum_val</span> <span class="o">=</span> <span class="n">poly_func</span><span class="p">(</span><span class="n">p_min</span><span class="p">)</span>
            <span class="n">new_points</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">p_max</span> <span class="o">-</span> <span class="n">p_min</span><span class="p">]</span>
            <span class="n">new_vals</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">poly_func</span><span class="p">(</span><span class="n">p_max</span><span class="p">)</span> <span class="o">-</span> <span class="n">minimum_val</span><span class="p">]</span>

            <span class="k">return</span> <span class="n">new_points</span><span class="p">,</span> <span class="n">new_vals</span><span class="p">,</span> <span class="n">minimum_val</span>

        <span class="c1"># actually quadratic</span>
        <span class="n">width</span> <span class="o">=</span> <span class="p">(</span><span class="n">p_max</span> <span class="o">-</span> <span class="n">p_min</span><span class="p">)</span> <span class="o">/</span> <span class="nb">float</span><span class="p">(</span><span class="n">segment_max</span><span class="p">)</span>

        <span class="n">new_points</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span> <span class="o">*</span> <span class="n">width</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">segment_max</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)]</span>

        <span class="c1"># replace the last with (p_max - p_min)</span>
        <span class="n">new_points</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">p_max</span> <span class="o">-</span> <span class="n">p_min</span>

        <span class="n">minimum_val</span> <span class="o">=</span> <span class="n">poly_func</span><span class="p">(</span><span class="n">p_min</span><span class="p">)</span>
        <span class="n">new_vals</span> <span class="o">=</span> <span class="p">[</span><span class="n">poly_func</span><span class="p">(</span><span class="n">pnt</span> <span class="o">+</span> <span class="n">p_min</span><span class="p">)</span> <span class="o">-</span> <span class="n">minimum_val</span> <span class="k">for</span> <span class="n">pnt</span> <span class="ow">in</span> <span class="n">new_points</span><span class="p">]</span>

        <span class="k">return</span> <span class="n">new_points</span><span class="p">,</span> <span class="n">new_vals</span><span class="p">,</span> <span class="n">minimum_val</span>

    <span class="k">def</span> <span class="nf">_piecewise_helper</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">p_min</span><span class="p">,</span> <span class="n">p_max</span><span class="p">,</span> <span class="n">curve</span><span class="p">,</span> <span class="n">curve_type</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">curve_type</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">curve</span> <span class="ow">or</span> <span class="n">curve</span><span class="p">[</span><span class="n">curve_type</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;piecewise&quot;</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">_piecewise_adjustment_helper</span><span class="p">(</span>
                <span class="n">m</span><span class="p">,</span> <span class="n">p_min</span><span class="p">,</span> <span class="n">p_max</span><span class="p">,</span> <span class="n">curve</span><span class="p">[</span><span class="s2">&quot;values&quot;</span><span class="p">]</span>
            <span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="k">assert</span> <span class="n">curve</span><span class="p">[</span><span class="n">curve_type</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;polynomial&quot;</span>
            <span class="k">return</span> <span class="n">_polynomial_to_piecewise_helper</span><span class="p">(</span>
                <span class="n">m</span><span class="p">,</span> <span class="n">p_min</span><span class="p">,</span> <span class="n">p_max</span><span class="p">,</span> <span class="n">curve</span><span class="p">[</span><span class="s2">&quot;values&quot;</span><span class="p">]</span>
            <span class="p">)</span>

    <span class="k">def</span> <span class="nf">power_generation_piecewise_points_rule</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">g</span><span class="p">):</span>
        <span class="c1"># NOTE: it is often (usually) the case that cost curves</span>
        <span class="c1">#       are the same in every time period, This function</span>
        <span class="c1">#       is optimized to avoid data redunancy and recalculation</span>
        <span class="c1">#       for that case</span>

        <span class="n">gen_dict</span> <span class="o">=</span> <span class="n">gens</span><span class="p">[</span><span class="n">g</span><span class="p">]</span>
        <span class="n">fuel_curve</span> <span class="o">=</span> <span class="n">gen_dict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;p_fuel&quot;</span><span class="p">)</span>
        <span class="n">cost_curve</span> <span class="o">=</span> <span class="n">gen_dict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;p_cost&quot;</span><span class="p">)</span>
        <span class="n">fuel_cost</span> <span class="o">=</span> <span class="n">gen_dict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;fuel_cost&quot;</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">)</span>
        <span class="n">no_load_cost</span> <span class="o">=</span> <span class="n">gen_dict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;non_fuel_no_load_cost&quot;</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">fuel_cost</span><span class="p">,</span> <span class="n">tupledict</span><span class="p">):</span>
            <span class="n">fuel_costs</span> <span class="o">=</span> <span class="n">fuel_cost</span><span class="p">[</span><span class="s2">&quot;values&quot;</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">fuel_costs</span> <span class="o">=</span> <span class="p">(</span><span class="n">fuel_cost</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">m</span><span class="o">.</span><span class="n">_TimePeriods</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">no_load_cost</span><span class="p">,</span> <span class="n">tupledict</span><span class="p">):</span>
            <span class="n">no_load_costs</span> <span class="o">=</span> <span class="n">no_load_cost</span><span class="p">[</span><span class="s2">&quot;values&quot;</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">no_load_costs</span> <span class="o">=</span> <span class="p">(</span><span class="n">no_load_cost</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="n">m</span><span class="o">.</span><span class="n">_TimePeriods</span><span class="p">)</span>

        <span class="n">_curve_cache</span> <span class="o">=</span> <span class="n">tupledict</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">fuel_curve</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">g_in_fuel_supply_generators</span> <span class="o">=</span> <span class="n">g</span> <span class="ow">in</span> <span class="n">m</span><span class="o">.</span><span class="n">_FuelSupplyGenerators</span>
            <span class="n">g_in_single_fuel_generators</span> <span class="o">=</span> <span class="n">g</span> <span class="ow">in</span> <span class="n">m</span><span class="o">.</span><span class="n">_SingleFuelGenerators</span>

            <span class="k">if</span> <span class="p">(</span>
                    <span class="nb">isinstance</span><span class="p">(</span><span class="n">fuel_curve</span><span class="p">,</span> <span class="n">tupledict</span><span class="p">)</span>
                    <span class="ow">and</span> <span class="n">fuel_curve</span><span class="p">[</span><span class="s2">&quot;data_type&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;time_series&quot;</span>
            <span class="p">):</span>
                <span class="n">fuel_curves</span> <span class="o">=</span> <span class="n">fuel_curve</span><span class="p">[</span><span class="s2">&quot;values&quot;</span><span class="p">]</span>
                <span class="n">one_fuel_curve</span> <span class="o">=</span> <span class="kc">False</span>

            <span class="k">else</span><span class="p">:</span>
                <span class="n">fuel_curves</span> <span class="o">=</span> <span class="p">(</span><span class="n">fuel_curve</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="n">m</span><span class="o">.</span><span class="n">_TimePeriods</span><span class="p">)</span>
                <span class="n">one_fuel_curve</span> <span class="o">=</span> <span class="kc">True</span>

            <span class="k">for</span> <span class="n">fuel_curve</span><span class="p">,</span> <span class="n">fuel_cost</span><span class="p">,</span> <span class="n">nlc</span><span class="p">,</span> <span class="n">t</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span>
                    <span class="n">fuel_curves</span><span class="p">,</span> <span class="n">fuel_costs</span><span class="p">,</span> <span class="n">no_load_costs</span><span class="p">,</span> <span class="n">m</span><span class="o">.</span><span class="n">_TimePeriods</span>
            <span class="p">):</span>
                <span class="n">p_min</span> <span class="o">=</span> <span class="n">m</span><span class="o">.</span><span class="n">_MinimumPowerOutput</span><span class="p">[</span><span class="n">g</span><span class="p">,</span> <span class="n">t</span><span class="p">]</span>
                <span class="n">p_max</span> <span class="o">=</span> <span class="n">m</span><span class="o">.</span><span class="n">_MaximumPowerOutput</span><span class="p">[</span><span class="n">g</span><span class="p">,</span> <span class="n">t</span><span class="p">]</span>

                <span class="k">if</span> <span class="p">(</span><span class="n">p_min</span><span class="p">,</span> <span class="n">p_max</span><span class="p">,</span> <span class="n">fuel_cost</span><span class="p">,</span> <span class="n">nlc</span><span class="p">)</span> <span class="ow">in</span> <span class="n">_curve_cache</span><span class="p">:</span>
                    <span class="n">curve</span> <span class="o">=</span> <span class="n">_curve_cache</span><span class="p">[</span><span class="n">p_min</span><span class="p">,</span> <span class="n">p_max</span><span class="p">,</span> <span class="n">fuel_cost</span><span class="p">,</span> <span class="n">nlc</span><span class="p">]</span>

                    <span class="k">if</span> <span class="n">one_fuel_curve</span> <span class="ow">or</span> <span class="n">curve</span><span class="p">[</span><span class="s2">&quot;fuel_curve&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">fuel_curve</span><span class="p">:</span>
                        <span class="n">m</span><span class="o">.</span><span class="n">_PowerGenerationPiecewisePoints</span><span class="p">[</span><span class="n">g</span><span class="p">,</span> <span class="n">t</span><span class="p">]</span> <span class="o">=</span> <span class="n">curve</span><span class="p">[</span>
                            <span class="s2">&quot;points&quot;</span>
                        <span class="p">]</span>

                        <span class="k">if</span> <span class="n">g_in_fuel_supply_generators</span><span class="p">:</span>
                            <span class="n">_minimum_fuel_consumption</span><span class="p">[</span><span class="n">g</span><span class="p">,</span> <span class="n">t</span><span class="p">]</span> <span class="o">=</span> <span class="n">curve</span><span class="p">[</span>
                                <span class="s2">&quot;min_fuel_consumption&quot;</span>
                            <span class="p">]</span>
                            <span class="n">m</span><span class="o">.</span><span class="n">_PowerGenerationPiecewiseFuelValues</span><span class="p">[</span>
                                <span class="n">g</span><span class="p">,</span> <span class="n">t</span>
                            <span class="p">]</span> <span class="o">=</span> <span class="n">curve</span><span class="p">[</span><span class="s2">&quot;fuel_values&quot;</span><span class="p">]</span>

                        <span class="k">if</span> <span class="n">g_in_single_fuel_generators</span><span class="p">:</span>
                            <span class="n">_minimum_production_cost</span><span class="p">[</span><span class="n">g</span><span class="p">,</span> <span class="n">t</span><span class="p">]</span> <span class="o">=</span> <span class="n">curve</span><span class="p">[</span>
                                <span class="s2">&quot;min_production_cost&quot;</span>
                            <span class="p">]</span>
                            <span class="n">m</span><span class="o">.</span><span class="n">_PowerGenerationPiecewiseCostValues</span><span class="p">[</span>
                                <span class="n">g</span><span class="p">,</span> <span class="n">t</span>
                            <span class="p">]</span> <span class="o">=</span> <span class="n">curve</span><span class="p">[</span><span class="s2">&quot;cost_values&quot;</span><span class="p">]</span>

                        <span class="k">continue</span>

                <span class="n">points</span><span class="p">,</span> <span class="n">values</span><span class="p">,</span> <span class="n">minimum_val</span> <span class="o">=</span> <span class="n">_piecewise_helper</span><span class="p">(</span>
                    <span class="n">m</span><span class="p">,</span> <span class="n">p_min</span><span class="p">,</span> <span class="n">p_max</span><span class="p">,</span> <span class="n">fuel_curve</span><span class="p">,</span> <span class="s2">&quot;fuel_curve_type&quot;</span>
                <span class="p">)</span>
                <span class="n">curve</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;points&quot;</span><span class="p">:</span> <span class="n">points</span><span class="p">}</span>

                <span class="k">if</span> <span class="ow">not</span> <span class="n">one_fuel_curve</span><span class="p">:</span>
                    <span class="n">curve</span><span class="p">[</span><span class="s2">&quot;fuel_curve&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">fuel_curve</span>

                <span class="n">m</span><span class="o">.</span><span class="n">_PowerGenerationPiecewisePoints</span><span class="p">[</span><span class="n">g</span><span class="p">,</span> <span class="n">t</span><span class="p">]</span> <span class="o">=</span> <span class="n">points</span>
                <span class="k">if</span> <span class="n">g_in_fuel_supply_generators</span><span class="p">:</span>
                    <span class="n">_minimum_fuel_consumption</span><span class="p">[</span><span class="n">g</span><span class="p">,</span> <span class="n">t</span><span class="p">]</span> <span class="o">=</span> <span class="n">minimum_val</span>
                    <span class="n">curve</span><span class="p">[</span><span class="s2">&quot;min_fuel_consumption&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">minimum_val</span>

                    <span class="n">m</span><span class="o">.</span><span class="n">_PowerGenerationPiecewiseFuelValues</span><span class="p">[</span><span class="n">g</span><span class="p">,</span> <span class="n">t</span><span class="p">]</span> <span class="o">=</span> <span class="n">values</span>
                    <span class="n">curve</span><span class="p">[</span><span class="s2">&quot;fuel_values&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">values</span>

                <span class="k">if</span> <span class="n">g_in_single_fuel_generators</span><span class="p">:</span>
                    <span class="n">min_production_cost</span> <span class="o">=</span> <span class="p">(</span>
                            <span class="n">minimum_val</span> <span class="o">*</span> <span class="n">fuel_cost</span> <span class="o">+</span> <span class="n">no_load_cost</span>
                    <span class="p">)</span>
                    <span class="n">_minimum_production_cost</span><span class="p">[</span><span class="n">g</span><span class="p">,</span> <span class="n">t</span><span class="p">]</span> <span class="o">=</span> <span class="n">min_production_cost</span>
                    <span class="n">curve</span><span class="p">[</span><span class="s2">&quot;min_production_cost&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">min_production_cost</span>

                    <span class="n">cost_values</span> <span class="o">=</span> <span class="p">[</span><span class="n">fuel_cost</span> <span class="o">*</span> <span class="n">val</span> <span class="k">for</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">values</span><span class="p">]</span>
                    <span class="n">m</span><span class="o">.</span><span class="n">_PowerGenerationPiecewiseCostValues</span><span class="p">[</span><span class="n">g</span><span class="p">,</span> <span class="n">t</span><span class="p">]</span> <span class="o">=</span> <span class="n">cost_values</span>
                    <span class="n">curve</span><span class="p">[</span><span class="s2">&quot;cost_values&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">cost_values</span>

                <span class="n">_curve_cache</span><span class="p">[</span><span class="n">p_min</span><span class="p">,</span> <span class="n">p_max</span><span class="p">,</span> <span class="n">fuel_cost</span><span class="p">,</span> <span class="n">nlc</span><span class="p">]</span> <span class="o">=</span> <span class="n">curve</span>

            <span class="k">return</span>  <span class="c1"># we can assume below that we don&#39;t have a fuel curve</span>

        <span class="k">if</span> <span class="p">(</span>
                <span class="nb">isinstance</span><span class="p">(</span><span class="n">cost_curve</span><span class="p">,</span> <span class="n">tupledict</span><span class="p">)</span>
                <span class="ow">and</span> <span class="n">cost_curve</span><span class="p">[</span><span class="s2">&quot;data_type&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;time_series&quot;</span>
        <span class="p">):</span>
            <span class="n">cost_curves</span> <span class="o">=</span> <span class="n">cost_curve</span><span class="p">[</span><span class="s2">&quot;values&quot;</span><span class="p">]</span>
            <span class="n">one_cost_curve</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="n">cost_curves</span> <span class="o">=</span> <span class="p">(</span><span class="n">cost_curve</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="n">m</span><span class="o">.</span><span class="n">_TimePeriods</span><span class="p">)</span>
            <span class="n">one_cost_curve</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="k">for</span> <span class="n">cost_curve</span><span class="p">,</span> <span class="n">nlc</span><span class="p">,</span> <span class="n">t</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span>
                <span class="n">cost_curves</span><span class="p">,</span> <span class="n">no_load_costs</span><span class="p">,</span> <span class="n">m</span><span class="o">.</span><span class="n">_TimePeriods</span>
        <span class="p">):</span>
            <span class="n">p_min</span> <span class="o">=</span> <span class="n">m</span><span class="o">.</span><span class="n">_MinimumPowerOutput</span><span class="p">[</span><span class="n">g</span><span class="p">,</span> <span class="n">t</span><span class="p">]</span>
            <span class="n">p_max</span> <span class="o">=</span> <span class="n">m</span><span class="o">.</span><span class="n">_MaximumPowerOutput</span><span class="p">[</span><span class="n">g</span><span class="p">,</span> <span class="n">t</span><span class="p">]</span>

            <span class="k">if</span> <span class="p">(</span><span class="n">p_min</span><span class="p">,</span> <span class="n">p_max</span><span class="p">,</span> <span class="n">nlc</span><span class="p">)</span> <span class="ow">in</span> <span class="n">_curve_cache</span><span class="p">:</span>
                <span class="n">curve</span> <span class="o">=</span> <span class="n">_curve_cache</span><span class="p">[</span><span class="n">p_min</span><span class="p">,</span> <span class="n">p_max</span><span class="p">,</span> <span class="n">nlc</span><span class="p">]</span>

                <span class="k">if</span> <span class="n">one_cost_curve</span> <span class="ow">or</span> <span class="n">curve</span><span class="p">[</span><span class="s2">&quot;cost_curve&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">cost_curve</span><span class="p">:</span>
                    <span class="n">m</span><span class="o">.</span><span class="n">_PowerGenerationPiecewisePoints</span><span class="p">[</span><span class="n">g</span><span class="p">,</span> <span class="n">t</span><span class="p">]</span> <span class="o">=</span> <span class="n">curve</span><span class="p">[</span><span class="s2">&quot;points&quot;</span><span class="p">]</span>
                    <span class="n">m</span><span class="o">.</span><span class="n">_PowerGenerationPiecewiseCostValues</span><span class="p">[</span><span class="n">g</span><span class="p">,</span> <span class="n">t</span><span class="p">]</span> <span class="o">=</span> <span class="n">curve</span><span class="p">[</span>
                        <span class="s2">&quot;cost_values&quot;</span>
                    <span class="p">]</span>
                    <span class="n">_minimum_production_cost</span><span class="p">[</span><span class="n">g</span><span class="p">,</span> <span class="n">t</span><span class="p">]</span> <span class="o">=</span> <span class="n">curve</span><span class="p">[</span><span class="s2">&quot;min_production&quot;</span><span class="p">]</span>

                    <span class="k">continue</span>

            <span class="k">if</span> <span class="n">cost_curve</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">p_min</span> <span class="o">&gt;=</span> <span class="n">p_max</span><span class="p">:</span>  <span class="c1"># only one point</span>
                    <span class="n">points</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.0</span><span class="p">]</span>
                    <span class="n">values</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.0</span><span class="p">]</span>

                <span class="k">else</span><span class="p">:</span>
                    <span class="n">points</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">p_max</span> <span class="o">-</span> <span class="n">p_min</span><span class="p">]</span>
                    <span class="n">values</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">]</span>

                <span class="n">min_production</span> <span class="o">=</span> <span class="n">nlc</span>

            <span class="k">else</span><span class="p">:</span>
                <span class="n">points</span><span class="p">,</span> <span class="n">values</span><span class="p">,</span> <span class="n">minimum_val</span> <span class="o">=</span> <span class="n">_piecewise_helper</span><span class="p">(</span>
                    <span class="n">m</span><span class="p">,</span> <span class="n">p_min</span><span class="p">,</span> <span class="n">p_max</span><span class="p">,</span> <span class="n">cost_curve</span><span class="p">,</span> <span class="s2">&quot;cost_curve_type&quot;</span>
                <span class="p">)</span>
                <span class="n">min_production</span> <span class="o">=</span> <span class="n">minimum_val</span> <span class="o">+</span> <span class="n">nlc</span>

            <span class="n">curve</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s2">&quot;points&quot;</span><span class="p">:</span> <span class="n">points</span><span class="p">,</span>
                <span class="s2">&quot;cost_values&quot;</span><span class="p">:</span> <span class="n">values</span><span class="p">,</span>
                <span class="s2">&quot;min_production&quot;</span><span class="p">:</span> <span class="n">min_production</span><span class="p">,</span>
            <span class="p">}</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">one_cost_curve</span><span class="p">:</span>
                <span class="n">curve</span><span class="p">[</span><span class="s2">&quot;cost_curve&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">cost_curve</span>

            <span class="n">_curve_cache</span><span class="p">[</span><span class="n">p_min</span><span class="p">,</span> <span class="n">p_max</span><span class="p">,</span> <span class="n">nlc</span><span class="p">]</span> <span class="o">=</span> <span class="n">curve</span>

            <span class="n">m</span><span class="o">.</span><span class="n">_PowerGenerationPiecewisePoints</span><span class="p">[</span><span class="n">g</span><span class="p">,</span> <span class="n">t</span><span class="p">]</span> <span class="o">=</span> <span class="n">points</span>
            <span class="n">m</span><span class="o">.</span><span class="n">_PowerGenerationPiecewiseCostValues</span><span class="p">[</span><span class="n">g</span><span class="p">,</span> <span class="n">t</span><span class="p">]</span> <span class="o">=</span> <span class="n">values</span>
            <span class="n">_minimum_production_cost</span><span class="p">[</span><span class="n">g</span><span class="p">,</span> <span class="n">t</span><span class="p">]</span> <span class="o">=</span> <span class="n">min_production</span>

    <span class="n">model</span><span class="o">.</span><span class="n">_CreatePowerGenerationPiecewisePoints</span> <span class="o">=</span> <span class="p">[</span>
        <span class="n">power_generation_piecewise_points_rule</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">g</span><span class="p">)</span> <span class="k">for</span> <span class="n">g</span> <span class="ow">in</span> <span class="n">cost_gens</span>
    <span class="p">]</span>

    <span class="c1"># Minimum production cost (needed because Piecewise constraint on</span>
    <span class="c1"># ProductionCost has to have lower bound of 0, so the unit can cost 0 when</span>
    <span class="c1"># off -- this is added back in to the objective if a unit is on</span>

    <span class="k">if</span> <span class="n">renew_costs</span><span class="p">:</span>
        <span class="n">model</span><span class="o">.</span><span class="n">_MinimumProductionCost</span> <span class="o">=</span> <span class="n">tupledict</span><span class="p">(</span>
            <span class="p">((</span><span class="n">g</span><span class="p">,</span> <span class="n">t</span><span class="p">),</span> <span class="n">_minimum_production_cost</span><span class="p">[</span><span class="n">g</span><span class="p">,</span> <span class="n">t</span><span class="p">])</span>
            <span class="k">for</span> <span class="n">g</span> <span class="ow">in</span> <span class="n">model</span><span class="o">.</span><span class="n">_SingleFuelGenerators</span>
            <span class="o">|</span> <span class="n">model</span><span class="o">.</span><span class="n">_AllNondispatchableGenerators</span>
            <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">model</span><span class="o">.</span><span class="n">_TimePeriods</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">g</span><span class="p">,</span> <span class="n">t</span><span class="p">)</span> <span class="ow">in</span> <span class="n">_minimum_production_cost</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
        <span class="p">)</span>

        <span class="n">model</span><span class="o">.</span><span class="n">_MinimumFuelConsumption</span> <span class="o">=</span> <span class="n">tupledict</span><span class="p">(</span>
            <span class="p">((</span><span class="n">g</span><span class="p">,</span> <span class="n">t</span><span class="p">),</span> <span class="n">_minimum_fuel_consumption</span><span class="p">[</span><span class="n">g</span><span class="p">,</span> <span class="n">t</span><span class="p">])</span>
            <span class="k">for</span> <span class="n">g</span> <span class="ow">in</span> <span class="n">model</span><span class="o">.</span><span class="n">_FuelSupplyGenerators</span>
            <span class="o">|</span> <span class="n">model</span><span class="o">.</span><span class="n">_AllNondispatchableGenerators</span>
            <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">model</span><span class="o">.</span><span class="n">_TimePeriods</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">g</span><span class="p">,</span> <span class="n">t</span><span class="p">)</span> <span class="ow">in</span> <span class="n">_minimum_fuel_consumption</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
        <span class="p">)</span>

    <span class="k">else</span><span class="p">:</span>
        <span class="n">model</span><span class="o">.</span><span class="n">_MinimumProductionCost</span> <span class="o">=</span> <span class="n">tupledict</span><span class="p">(</span>
            <span class="p">((</span><span class="n">g</span><span class="p">,</span> <span class="n">t</span><span class="p">),</span> <span class="n">_minimum_production_cost</span><span class="p">[</span><span class="n">g</span><span class="p">,</span> <span class="n">t</span><span class="p">])</span>
            <span class="k">for</span> <span class="n">g</span> <span class="ow">in</span> <span class="n">model</span><span class="o">.</span><span class="n">_SingleFuelGenerators</span>
            <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">model</span><span class="o">.</span><span class="n">_TimePeriods</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">g</span><span class="p">,</span> <span class="n">t</span><span class="p">)</span> <span class="ow">in</span> <span class="n">_minimum_production_cost</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
        <span class="p">)</span>

        <span class="n">model</span><span class="o">.</span><span class="n">_MinimumFuelConsumption</span> <span class="o">=</span> <span class="n">tupledict</span><span class="p">(</span>
            <span class="p">((</span><span class="n">g</span><span class="p">,</span> <span class="n">t</span><span class="p">),</span> <span class="n">_minimum_fuel_consumption</span><span class="p">[</span><span class="n">g</span><span class="p">,</span> <span class="n">t</span><span class="p">])</span>
            <span class="k">for</span> <span class="n">g</span> <span class="ow">in</span> <span class="n">model</span><span class="o">.</span><span class="n">_FuelSupplyGenerators</span>
            <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">model</span><span class="o">.</span><span class="n">_TimePeriods</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">g</span><span class="p">,</span> <span class="n">t</span><span class="p">)</span> <span class="ow">in</span> <span class="n">_minimum_fuel_consumption</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
        <span class="p">)</span>

    <span class="c1"># END PRODUCTION COST CALCULATIONS</span>

    <span class="c1"># penalty costs for constraint violation #</span>

    <span class="n">kinda_big_penalty</span> <span class="o">=</span> <span class="mf">1e3</span> <span class="o">*</span> <span class="n">model_data</span><span class="o">.</span><span class="n">get_system_attr</span><span class="p">(</span><span class="s2">&quot;baseMVA&quot;</span><span class="p">)</span>
    <span class="n">big_penalty</span> <span class="o">=</span> <span class="mf">1e4</span> <span class="o">*</span> <span class="n">model_data</span><span class="o">.</span><span class="n">get_system_attr</span><span class="p">(</span><span class="s2">&quot;baseMVA&quot;</span><span class="p">)</span>

    <span class="n">model</span><span class="o">.</span><span class="n">_ReserveShortfallPenalty</span> <span class="o">=</span> <span class="n">model_data</span><span class="o">.</span><span class="n">get_system_attr</span><span class="p">(</span>
        <span class="s2">&quot;reserve_shortfall_cost&quot;</span><span class="p">,</span> <span class="n">kinda_big_penalty</span>
    <span class="p">)</span>

    <span class="n">model</span><span class="o">.</span><span class="n">_LoadMismatchPenalty</span> <span class="o">=</span> <span class="n">model_data</span><span class="o">.</span><span class="n">get_system_attr</span><span class="p">(</span>
        <span class="s2">&quot;load_mismtch_cost&quot;</span><span class="p">,</span> <span class="n">big_penalty</span>
    <span class="p">)</span>

    <span class="n">model</span><span class="o">.</span><span class="n">_LoadMismatchPenaltyReactive</span> <span class="o">=</span> <span class="n">model_data</span><span class="o">.</span><span class="n">get_system_attr</span><span class="p">(</span>
        <span class="s2">&quot;q_load_mismatch_cost&quot;</span><span class="p">,</span> <span class="n">big_penalty</span> <span class="o">/</span> <span class="mf">2.0</span>
    <span class="p">)</span>

    <span class="n">model</span><span class="o">.</span><span class="n">_Contingencies</span> <span class="o">=</span> <span class="n">OrderedSet</span><span class="p">(</span><span class="n">contingencies</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>

    <span class="c1"># leaving this unindexed for now for simpility</span>
    <span class="n">model</span><span class="o">.</span><span class="n">_ContingencyLimitPenalty</span> <span class="o">=</span> <span class="n">model_data</span><span class="o">.</span><span class="n">get_system_attr</span><span class="p">(</span>
        <span class="s2">&quot;contingency_flow_violation_cost&quot;</span><span class="p">,</span> <span class="n">big_penalty</span> <span class="o">/</span> <span class="mf">2.0</span>
    <span class="p">)</span>

    <span class="c1"># STORAGE parameters</span>

    <span class="n">model</span><span class="o">.</span><span class="n">_Storage</span> <span class="o">=</span> <span class="n">OrderedSet</span><span class="p">(</span><span class="n">storage_attrs</span><span class="p">[</span><span class="s2">&quot;names&quot;</span><span class="p">])</span>
    <span class="n">model</span><span class="o">.</span><span class="n">_StorageAtBus</span> <span class="o">=</span> <span class="n">tupledict</span><span class="p">(</span><span class="n">storage_by_bus</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">verify_storage_buses_rule</span><span class="p">(</span><span class="n">m</span><span class="p">):</span>
        <span class="k">assert</span> <span class="nb">set</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">_Storage</span><span class="p">)</span> <span class="o">==</span> <span class="p">{</span>
            <span class="n">store</span> <span class="k">for</span> <span class="n">bus</span> <span class="ow">in</span> <span class="n">m</span><span class="o">.</span><span class="n">_Buses</span> <span class="k">for</span> <span class="n">store</span> <span class="ow">in</span> <span class="n">m</span><span class="o">.</span><span class="n">_StorageAtBus</span><span class="p">[</span><span class="n">bus</span><span class="p">]</span>
        <span class="p">}</span>

    <span class="n">model</span><span class="o">.</span><span class="n">_VerifyStorageBuses</span> <span class="o">=</span> <span class="n">verify_storage_buses_rule</span><span class="p">(</span><span class="n">model</span><span class="p">)</span>

    <span class="c1"># minimum and maximum power ratings, for each storage unit. units are MW.          #</span>
    <span class="c1"># could easily be specified on a per-time period basis, but are not currently.     #</span>

    <span class="c1"># Storage power output &gt;0 when discharging</span>

    <span class="n">model</span><span class="o">.</span><span class="n">_MinimumPowerOutputStorage</span> <span class="o">=</span> <span class="n">tupledict</span><span class="p">(</span>
        <span class="n">storage_attrs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
            <span class="s2">&quot;min_discharge_rate&quot;</span><span class="p">,</span> <span class="p">{</span><span class="n">storage</span><span class="p">:</span> <span class="mi">0</span> <span class="k">for</span> <span class="n">storage</span> <span class="ow">in</span> <span class="n">model</span><span class="o">.</span><span class="n">_Storage</span><span class="p">}</span>
        <span class="p">)</span>
    <span class="p">)</span>

    <span class="k">def</span> <span class="nf">maximum_power_output_validator_storage</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">v</span><span class="p">,</span> <span class="n">s</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">v</span> <span class="o">&gt;=</span> <span class="n">m</span><span class="o">.</span><span class="n">_MinimumPowerOutputStorage</span><span class="p">[</span><span class="n">s</span><span class="p">]</span>

    <span class="n">model</span><span class="o">.</span><span class="n">_MaximumPowerOutputStorage</span> <span class="o">=</span> <span class="n">tupledict</span><span class="p">(</span>
        <span class="n">storage_attrs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
            <span class="s2">&quot;max_discharge_rate&quot;</span><span class="p">,</span> <span class="p">{</span><span class="n">storage</span><span class="p">:</span> <span class="mi">0</span> <span class="k">for</span> <span class="n">storage</span> <span class="ow">in</span> <span class="n">model</span><span class="o">.</span><span class="n">_Storage</span><span class="p">}</span>
        <span class="p">)</span>
    <span class="p">)</span>
    <span class="k">if</span> <span class="n">model</span><span class="o">.</span><span class="n">_MaximumPowerOutputStorage</span><span class="p">:</span>
        <span class="n">maximumpoweroutput_validate</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">maximum_power_output_validator_storage</span><span class="p">(</span>
                <span class="n">model</span><span class="p">,</span> <span class="n">model</span><span class="o">.</span><span class="n">_MaximumPowerOutputStorage</span><span class="p">[</span><span class="n">s</span><span class="p">],</span> <span class="n">s</span>
            <span class="p">)</span>
            <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">model</span><span class="o">.</span><span class="n">_Storage</span>
        <span class="p">]</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">any</span><span class="p">(</span><span class="n">maximumpoweroutput_validate</span><span class="p">):</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                <span class="s2">&quot;Maximum power output should be less than Minimum power output&quot;</span>
            <span class="p">)</span>

    <span class="c1"># Storage power input &gt;0 when charging</span>
    <span class="n">model</span><span class="o">.</span><span class="n">_MinimumPowerInputStorage</span> <span class="o">=</span> <span class="n">tupledict</span><span class="p">(</span>
        <span class="n">storage_attrs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
            <span class="s2">&quot;min_charge_rate&quot;</span><span class="p">,</span> <span class="p">{</span><span class="n">storage</span><span class="p">:</span> <span class="mi">0</span> <span class="k">for</span> <span class="n">storage</span> <span class="ow">in</span> <span class="n">model</span><span class="o">.</span><span class="n">_Storage</span><span class="p">}</span>
        <span class="p">)</span>
    <span class="p">)</span>

    <span class="k">def</span> <span class="nf">maximum_power_input_validator_storage</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">v</span><span class="p">,</span> <span class="n">s</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">v</span> <span class="o">&gt;=</span> <span class="n">m</span><span class="o">.</span><span class="n">_MinimumPowerInputStorage</span><span class="p">[</span><span class="n">s</span><span class="p">]</span>

    <span class="n">model</span><span class="o">.</span><span class="n">_MaximumPowerInputStorage</span> <span class="o">=</span> <span class="n">tupledict</span><span class="p">(</span>
        <span class="n">storage_attrs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
            <span class="s2">&quot;max_charge_rate&quot;</span><span class="p">,</span> <span class="p">{</span><span class="n">storage</span><span class="p">:</span> <span class="mi">0</span> <span class="k">for</span> <span class="n">storage</span> <span class="ow">in</span> <span class="n">model</span><span class="o">.</span><span class="n">_Storage</span><span class="p">}</span>
        <span class="p">)</span>
    <span class="p">)</span>

    <span class="k">def</span> <span class="nf">maximum_power_input_validator_storage</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">v</span><span class="p">,</span> <span class="n">s</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">v</span> <span class="o">&gt;=</span> <span class="n">m</span><span class="o">.</span><span class="n">_MinimumPowerInputStorage</span><span class="p">[</span><span class="n">s</span><span class="p">]</span>

    <span class="k">if</span> <span class="n">model</span><span class="o">.</span><span class="n">_MaximumPowerInputStorage</span><span class="p">:</span>
        <span class="n">maximumpowerinput_validate</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">maximum_power_input_validator_storage</span><span class="p">(</span>
                <span class="n">model</span><span class="p">,</span> <span class="n">model</span><span class="o">.</span><span class="n">_MaximumPowerInputStorage</span><span class="p">[</span><span class="n">s</span><span class="p">],</span> <span class="n">s</span>
            <span class="p">)</span>
            <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">model</span><span class="o">.</span><span class="n">_Storage</span>
        <span class="p">]</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">any</span><span class="p">(</span><span class="n">maximumpowerinput_validate</span><span class="p">):</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                <span class="s2">&quot;Maximum power input should be less than Minimum power output&quot;</span>
            <span class="p">)</span>

    <span class="c1"># storage ramp up/down rates. units are MW/h. #</span>

    <span class="c1"># ramp rate limits when discharging</span>
    <span class="n">model</span><span class="o">.</span><span class="n">_NominalRampUpLimitStorageOutput</span> <span class="o">=</span> <span class="n">tupledict</span><span class="p">(</span>
        <span class="n">storage_attrs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
            <span class="s2">&quot;ramp_up_output_60min&quot;</span><span class="p">,</span>
            <span class="p">{</span><span class="n">storage</span><span class="p">:</span> <span class="kc">None</span> <span class="k">for</span> <span class="n">storage</span> <span class="ow">in</span> <span class="n">model</span><span class="o">.</span><span class="n">_Storage</span><span class="p">},</span>
        <span class="p">)</span>
    <span class="p">)</span>

    <span class="n">model</span><span class="o">.</span><span class="n">_NominalRampDownLimitStorageOutput</span> <span class="o">=</span> <span class="n">tupledict</span><span class="p">(</span>
        <span class="n">storage_attrs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
            <span class="s2">&quot;ramp_down_output_60min&quot;</span><span class="p">,</span>
            <span class="p">{</span><span class="n">storage</span><span class="p">:</span> <span class="kc">None</span> <span class="k">for</span> <span class="n">storage</span> <span class="ow">in</span> <span class="n">model</span><span class="o">.</span><span class="n">_Storage</span><span class="p">},</span>
        <span class="p">)</span>
    <span class="p">)</span>

    <span class="c1"># ramp rate limits when charging</span>
    <span class="n">model</span><span class="o">.</span><span class="n">_NominalRampUpLimitStorageInput</span> <span class="o">=</span> <span class="n">tupledict</span><span class="p">(</span>
        <span class="n">storage_attrs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
            <span class="s2">&quot;ramp_up_input_60min&quot;</span><span class="p">,</span>
            <span class="p">{</span><span class="n">storage</span><span class="p">:</span> <span class="kc">None</span> <span class="k">for</span> <span class="n">storage</span> <span class="ow">in</span> <span class="n">model</span><span class="o">.</span><span class="n">_Storage</span><span class="p">},</span>
        <span class="p">)</span>
    <span class="p">)</span>

    <span class="n">model</span><span class="o">.</span><span class="n">_NominalRampDownLimitStorageInput</span> <span class="o">=</span> <span class="n">tupledict</span><span class="p">(</span>
        <span class="n">storage_attrs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
            <span class="s2">&quot;ramp_down_input_60min&quot;</span><span class="p">,</span>
            <span class="p">{</span><span class="n">storage</span><span class="p">:</span> <span class="kc">None</span> <span class="k">for</span> <span class="n">storage</span> <span class="ow">in</span> <span class="n">model</span><span class="o">.</span><span class="n">_Storage</span><span class="p">},</span>
        <span class="p">)</span>
    <span class="p">)</span>

    <span class="k">def</span> <span class="nf">scale_storage_ramp_up_out</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">s</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">m</span><span class="o">.</span><span class="n">_NominalRampUpLimitStorageOutput</span><span class="p">[</span><span class="n">s</span><span class="p">]</span> <span class="o">*</span> <span class="n">m</span><span class="o">.</span><span class="n">_TimePeriodLengthHours</span>

    <span class="n">model</span><span class="o">.</span><span class="n">_ScaledNominalRampUpLimitStorageOutput</span> <span class="o">=</span> <span class="n">tupledict</span><span class="p">(</span>
        <span class="p">{</span><span class="n">s</span><span class="p">:</span> <span class="n">scale_storage_ramp_up_out</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">s</span><span class="p">)</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">model</span><span class="o">.</span><span class="n">_Storage</span><span class="p">}</span>
    <span class="p">)</span>

    <span class="k">def</span> <span class="nf">scale_storage_ramp_down_out</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">s</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">(</span>
                <span class="n">m</span><span class="o">.</span><span class="n">_NominalRampDownLimitStorageOutput</span><span class="p">[</span>
                    <span class="n">s</span><span class="p">]</span> <span class="o">*</span> <span class="n">m</span><span class="o">.</span><span class="n">_TimePeriodLengthHours</span>
        <span class="p">)</span>

    <span class="n">model</span><span class="o">.</span><span class="n">_ScaledNominalRampUpLimitStorageOutput</span> <span class="o">=</span> <span class="n">tupledict</span><span class="p">(</span>
        <span class="p">{</span><span class="n">s</span><span class="p">:</span> <span class="n">scale_storage_ramp_down_out</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">s</span><span class="p">)</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">model</span><span class="o">.</span><span class="n">_Storage</span><span class="p">}</span>
    <span class="p">)</span>

    <span class="k">def</span> <span class="nf">scale_storage_ramp_up_in</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">s</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">m</span><span class="o">.</span><span class="n">_NominalRampUpLimitStorageInput</span><span class="p">[</span><span class="n">s</span><span class="p">]</span> <span class="o">*</span> <span class="n">m</span><span class="o">.</span><span class="n">_TimePeriodLengthHours</span>

    <span class="n">model</span><span class="o">.</span><span class="n">_ScaledNominalRampUpLimitStorageInput</span> <span class="o">=</span> <span class="n">tupledict</span><span class="p">(</span>
        <span class="p">{</span><span class="n">s</span><span class="p">:</span> <span class="n">scale_storage_ramp_up_in</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">s</span><span class="p">)</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">model</span><span class="o">.</span><span class="n">_Storage</span><span class="p">}</span>
    <span class="p">)</span>

    <span class="k">def</span> <span class="nf">scale_storage_ramp_down_in</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">s</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">(</span>
                <span class="n">m</span><span class="o">.</span><span class="n">_NominalRampDownLimitStorageInput</span><span class="p">[</span>
                    <span class="n">s</span><span class="p">]</span> <span class="o">*</span> <span class="n">m</span><span class="o">.</span><span class="n">_TimePeriodLengthHours</span>
        <span class="p">)</span>

    <span class="n">model</span><span class="o">.</span><span class="n">_ScaledNominalRampDownLimitStorageInput</span> <span class="o">=</span> <span class="n">tupledict</span><span class="p">(</span>
        <span class="p">{</span><span class="n">s</span><span class="p">:</span> <span class="n">scale_storage_ramp_down_in</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">s</span><span class="p">)</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">model</span><span class="o">.</span><span class="n">_Storage</span><span class="p">}</span>
    <span class="p">)</span>

    <span class="c1"># minimum state of charge (SOC) and maximum energy ratings, for each storage unit.</span>
    <span class="c1"># units are MWh for energy rating and p.u. (i.e. [0,1]) for SOC</span>

    <span class="c1"># you enter storage energy ratings once for each storage unit</span>

    <span class="n">model</span><span class="o">.</span><span class="n">_MaximumEnergyStorage</span> <span class="o">=</span> <span class="n">tupledict</span><span class="p">(</span>
        <span class="n">storage_attrs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;energy_capacity&quot;</span><span class="p">,</span> <span class="p">{</span><span class="n">s</span><span class="p">:</span> <span class="mi">0</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">model</span><span class="o">.</span><span class="n">_Storage</span><span class="p">})</span>
    <span class="p">)</span>

    <span class="n">model</span><span class="o">.</span><span class="n">_MinimumSocStorage</span> <span class="o">=</span> <span class="n">tupledict</span><span class="p">(</span>
        <span class="n">storage_attrs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
            <span class="s2">&quot;minimum_state_of_charge&quot;</span><span class="p">,</span> <span class="p">{</span><span class="n">s</span><span class="p">:</span> <span class="mi">0</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">model</span><span class="o">.</span><span class="n">_Storage</span><span class="p">}</span>
        <span class="p">)</span>
    <span class="p">)</span>

    <span class="c1"># round trip efficiency for each storage unit given as a fraction (i.e. [0,1])</span>

    <span class="n">model</span><span class="o">.</span><span class="n">_InputEfficiencyEnergy</span> <span class="o">=</span> <span class="n">tupledict</span><span class="p">(</span>
        <span class="n">storage_attrs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;charge_efficiency&quot;</span><span class="p">,</span> <span class="p">{</span><span class="n">s</span><span class="p">:</span> <span class="mi">1</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">model</span><span class="o">.</span><span class="n">_Storage</span><span class="p">})</span>
    <span class="p">)</span>
    <span class="n">model</span><span class="o">.</span><span class="n">_OutputEfficiencyEnergy</span> <span class="o">=</span> <span class="n">tupledict</span><span class="p">(</span>
        <span class="n">storage_attrs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
            <span class="s2">&quot;discharge_efficiency&quot;</span><span class="p">,</span> <span class="p">{</span><span class="n">s</span><span class="p">:</span> <span class="mi">1</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">model</span><span class="o">.</span><span class="n">_Storage</span><span class="p">}</span>
        <span class="p">)</span>
    <span class="p">)</span>

    <span class="c1"># assumed to be %/hr</span>
    <span class="n">model</span><span class="o">.</span><span class="n">_RetentionRate</span> <span class="o">=</span> <span class="n">tupledict</span><span class="p">(</span>
        <span class="n">storage_attrs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
            <span class="s2">&quot;retention_rate_60min&quot;</span><span class="p">,</span> <span class="p">{</span><span class="n">s</span><span class="p">:</span> <span class="mi">1</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">model</span><span class="o">.</span><span class="n">_Storage</span><span class="p">}</span>
        <span class="p">)</span>
    <span class="p">)</span>

    <span class="n">model</span><span class="o">.</span><span class="n">_ChargeCost</span> <span class="o">=</span> <span class="n">tupledict</span><span class="p">(</span>
        <span class="n">storage_attrs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;charge_cost&quot;</span><span class="p">,</span> <span class="p">{</span><span class="n">s</span><span class="p">:</span> <span class="mi">0</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">model</span><span class="o">.</span><span class="n">_Storage</span><span class="p">})</span>
    <span class="p">)</span>

    <span class="n">model</span><span class="o">.</span><span class="n">_DisChargeCost</span> <span class="o">=</span> <span class="n">tupledict</span><span class="p">(</span>
        <span class="n">storage_attrs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;discharge_cost&quot;</span><span class="p">,</span> <span class="p">{</span><span class="n">s</span><span class="p">:</span> <span class="mi">0</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">model</span><span class="o">.</span><span class="n">_Storage</span><span class="p">})</span>
    <span class="p">)</span>

    <span class="c1"># this will be multiplied by itself 1/m.TimePeriodLengthHours times, so</span>
    <span class="c1"># this is the scaling to get us back to %/hr</span>
    <span class="k">def</span> <span class="nf">scaled_retention_rate</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">s</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">m</span><span class="o">.</span><span class="n">_RetentionRate</span><span class="p">[</span><span class="n">s</span><span class="p">]</span> <span class="o">**</span> <span class="n">m</span><span class="o">.</span><span class="n">_TimePeriodLengthHours</span>

    <span class="n">model</span><span class="o">.</span><span class="n">_DisChargeCost</span> <span class="o">=</span> <span class="n">tupledict</span><span class="p">(</span>
        <span class="n">storage_attrs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;discharge_cost&quot;</span><span class="p">,</span> <span class="p">{</span><span class="n">s</span><span class="p">:</span> <span class="kc">None</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">model</span><span class="o">.</span><span class="n">_Storage</span><span class="p">})</span>
    <span class="p">)</span>

    <span class="n">model</span><span class="o">.</span><span class="n">_ScaledRetentionRate</span> <span class="o">=</span> <span class="n">tupledict</span><span class="p">(</span>
        <span class="p">{</span><span class="n">s</span><span class="p">:</span> <span class="n">scaled_retention_rate</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">s</span><span class="p">)</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">model</span><span class="o">.</span><span class="n">_Storage</span><span class="p">}</span>
    <span class="p">)</span>

    <span class="c1"># end-point SOC for each storage unit. units are in p.u. (i.e. [0,1])</span>

    <span class="c1"># end-point values are the SOC targets at the final time period. With no</span>
    <span class="c1"># end-point constraints storage units will always be empty at the final</span>
    <span class="c1"># time period.</span>
    <span class="k">def</span> <span class="nf">_end_point_soc</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">s</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">s</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="n">s_dict</span> <span class="o">=</span> <span class="n">storage</span><span class="p">[</span><span class="n">s</span><span class="p">]</span>
        <span class="k">if</span> <span class="s2">&quot;end_state_of_charge&quot;</span> <span class="ow">in</span> <span class="n">s_dict</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">s_dict</span><span class="p">[</span><span class="s2">&quot;end_state_of_charge&quot;</span><span class="p">]</span>
        <span class="k">if</span> <span class="s2">&quot;initial_state_of_charge&quot;</span> <span class="ow">in</span> <span class="n">s_dict</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">s_dict</span><span class="p">[</span><span class="s2">&quot;initial_state_of_charge&quot;</span><span class="p">]</span>

        <span class="k">return</span> <span class="mf">0.5</span>

    <span class="n">model</span><span class="o">.</span><span class="n">_EndPointSocStorage</span> <span class="o">=</span> <span class="n">tupledict</span><span class="p">(</span>
        <span class="p">{</span><span class="n">s</span><span class="p">:</span> <span class="n">_end_point_soc</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">s</span><span class="p">)</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">model</span><span class="o">.</span><span class="n">_Storage</span><span class="p">}</span>
    <span class="p">)</span>

    <span class="c1"># storage initial conditions: SOC, power output and input</span>

    <span class="k">def</span> <span class="nf">t0_storage_power_input_validator</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">v</span><span class="p">,</span> <span class="n">s</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">_MinimumPowerInputStorage</span><span class="p">[</span><span class="n">s</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">v</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span>
                <span class="n">v</span> <span class="o">&lt;=</span> <span class="n">m</span><span class="o">.</span><span class="n">_MaximumPowerInputStorage</span><span class="p">[</span><span class="n">s</span><span class="p">]</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="nf">t0_storage_power_output_validator</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">v</span><span class="p">,</span> <span class="n">s</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">_MinimumPowerOutputStorage</span><span class="p">[</span><span class="n">s</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">v</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span>
                <span class="n">v</span> <span class="o">&lt;=</span> <span class="n">m</span><span class="o">.</span><span class="n">_MaximumPowerOutputStorage</span><span class="p">[</span><span class="n">s</span><span class="p">]</span>
        <span class="p">)</span>

    <span class="n">model</span><span class="o">.</span><span class="n">_StoragePowerOutputOnT0</span> <span class="o">=</span> <span class="n">tupledict</span><span class="p">(</span>
        <span class="n">storage_attrs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
            <span class="s2">&quot;initial_discharge_rate&quot;</span><span class="p">,</span> <span class="p">{</span><span class="n">s</span><span class="p">:</span> <span class="mi">0</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">model</span><span class="o">.</span><span class="n">_Storage</span><span class="p">}</span>
        <span class="p">)</span>
    <span class="p">)</span>
    <span class="n">model</span><span class="o">.</span><span class="n">_StoragePowerInputOnT0</span> <span class="o">=</span> <span class="n">tupledict</span><span class="p">(</span>
        <span class="n">storage_attrs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
            <span class="s2">&quot;initial_charge_rate&quot;</span><span class="p">,</span> <span class="p">{</span><span class="n">s</span><span class="p">:</span> <span class="mi">0</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">model</span><span class="o">.</span><span class="n">_Storage</span><span class="p">}</span>
        <span class="p">)</span>
    <span class="p">)</span>

    <span class="k">if</span> <span class="n">model</span><span class="o">.</span><span class="n">_StoragePowerInputOnT0</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">any</span><span class="p">(</span>
                <span class="p">[</span>
                    <span class="n">t0_storage_power_input_validator</span><span class="p">(</span>
                        <span class="n">model</span><span class="p">,</span> <span class="n">model</span><span class="o">.</span><span class="n">_StoragePowerInputOnT0</span><span class="p">[</span><span class="n">s</span><span class="p">],</span> <span class="n">s</span>
                    <span class="p">)</span>
                    <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">model</span><span class="o">.</span><span class="n">_Storage</span>
                <span class="p">]</span>
        <span class="p">):</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                <span class="s2">&quot;Storage Power Input should between its min and max&quot;</span>
            <span class="p">)</span>

    <span class="k">if</span> <span class="n">model</span><span class="o">.</span><span class="n">_StoragePowerOutputOnT0</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">any</span><span class="p">(</span>
                <span class="p">[</span>
                    <span class="n">t0_storage_power_output_validator</span><span class="p">(</span>
                        <span class="n">model</span><span class="p">,</span> <span class="n">model</span><span class="o">.</span><span class="n">_StoragePowerOutputOnT0</span><span class="p">[</span><span class="n">s</span><span class="p">],</span> <span class="n">s</span>
                    <span class="p">)</span>
                    <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">model</span><span class="o">.</span><span class="n">_Storage</span>
                <span class="p">]</span>
        <span class="p">):</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                <span class="s2">&quot;Storage Power Output should between its min and max&quot;</span>
            <span class="p">)</span>

    <span class="n">model</span><span class="o">.</span><span class="n">_StorageSocOnT0</span> <span class="o">=</span> <span class="n">tupledict</span><span class="p">(</span>
        <span class="n">storage_attrs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
            <span class="s2">&quot;initial_state_of_charge&quot;</span><span class="p">,</span> <span class="p">{</span><span class="n">s</span><span class="p">:</span> <span class="mf">0.5</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">model</span><span class="o">.</span><span class="n">_Storage</span><span class="p">}</span>
        <span class="p">)</span>
    <span class="p">)</span>
    <span class="k">return</span> <span class="n">model</span></div>
</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2023, Junying (Alice) Fang.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>